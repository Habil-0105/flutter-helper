#!/bin/bash
set -e
# --- File to store flavor history ---
FLAVOR_LIST_FILE="$HOME/.flutter_flavor_list"
FLAVOR_FILE="$HOME/.flutter_build_flavor"

# --- Function: Validate Flutter project ---
validate_flutter_project() {
 if [ ! -f "pubspec.yaml" ]; then
  echo ":x: Error: Not a Flutter project! (pubspec.yaml not found)"
  echo "Please run this script from a Flutter project directory."
  exit 1
 fi
}

# --- Function: Validate Flutter/FVM installation ---
validate_flutter_installation() {
 local cmd="$1"
 if ! command -v $cmd &> /dev/null; then
  echo ":x: Error: $cmd is not installed or not in PATH!"
  if [ "$cmd" = "fvm" ]; then
   echo "Please install FVM: https://fvm.app/docs/getting_started/installation"
  else
   echo "Please install Flutter: https://flutter.dev/docs/get-started/install"
  fi
  exit 1
 fi
}

# --- Function: Get project root folder name ---
get_project_name() {
 basename "$(pwd)"
}

# --- Function: Validate flavor exists in project ---
validate_flavor() {
 local flavor="$1"
 
 if [ -z "$flavor" ]; then
  return 0  # No flavor is valid
 fi
 
 # Check flavorizr.yaml (primary source for flavorizr package)
 if [ -f "flavorizr.yaml" ]; then
  # Check if flavor exists in flavorizr.yaml
  # flavorizr.yaml typically has flavors defined under a 'flavors' key
  if grep -q "$flavor" flavorizr.yaml 2>/dev/null; then
   # More specific check: look for the flavor name as a key or in flavor definitions
   if grep -E "^[[:space:]]*$flavor[[:space:]]*:" flavorizr.yaml 2>/dev/null || \
      grep -E "[[:space:]]*$flavor[[:space:]]*:" flavorizr.yaml 2>/dev/null; then
    return 0  # Flavor found in flavorizr.yaml
   fi
   # Also check if it's in a list format
   if grep -E "['\"]$flavor['\"]" flavorizr.yaml 2>/dev/null; then
    return 0
   fi
  fi
 fi
 
 # Check pubspec.yaml for flavorizr configuration
 if [ -f "pubspec.yaml" ]; then
  # Check if flavorizr is configured and flavor is mentioned
  if grep -q "flavorizr" pubspec.yaml 2>/dev/null; then
   # Check if flavor name appears in pubspec.yaml (might be in flavorizr config)
   if grep -q "$flavor" pubspec.yaml 2>/dev/null; then
    return 0  # Flavor found in pubspec.yaml
   fi
  fi
 fi
 
 # Check android/app/flavorizr.gradle (Android flavorizr generated file)
 if [ -f "android/app/flavorizr.gradle" ]; then
  if grep -q "$flavor" android/app/flavorizr.gradle 2>/dev/null; then
   return 0  # Flavor found in flavorizr.gradle
  fi
 fi
 
 # Fallback: Check Android flavors in build.gradle (for non-flavorizr projects)
 if [ -f "android/app/build.gradle" ]; then
  # Look for productFlavors block and check if flavor name appears within it
  if grep -q "productFlavors" android/app/build.gradle; then
   # Extract the productFlavors section and check if flavor name appears within it
   if awk '/productFlavors\s*\{/,/^[[:space:]]*\}/ { if (index($0, "'"$flavor"'")) found=1 } END { exit !found }' android/app/build.gradle 2>/dev/null; then
    return 0  # Flavor found in Android productFlavors
   fi
  fi
 fi
 
 # Check iOS - look for flavor in Xcode project files or Info.plist
 # iOS flavor validation is more complex, so we'll check common locations
 if [ -d "ios" ]; then
  # Check if flavor appears in any iOS configuration files
  # This is a lenient check - if Android doesn't exist, we assume iOS might have it
  if [ ! -d "android" ]; then
   # iOS-only project - be lenient and assume flavor might be valid
   return 0
  fi
 fi
 
 # If we reach here and Android exists but flavor not found, it's invalid
 if [ -d "android" ]; then
  return 1  # Flavor not found in Android project
 fi
 
 # Default: assume valid if we can't determine (for edge cases)
 return 0
}

# --- Function: Send cross-platform notification ---
send_notification() {
 local title="$1"
 local message="$2"
 local sound="${3:-true}"
 local project_name=$(get_project_name)
 
 # Add project name to title
 local full_title="$title - $project_name"
 
 # Detect OS
 if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOS - use osascript
  if [ "$sound" = "true" ]; then
   osascript -e "display notification \"$message\" with title \"$full_title\" sound name \"Glass\""
  else
   osascript -e "display notification \"$message\" with title \"$full_title\""
  fi
 elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
  # Linux - use notify-send
  if command -v notify-send &> /dev/null; then
   if [ "$sound" = "true" ]; then
    notify-send -u normal -i "dialog-information" "$full_title" "$message"
   else
    notify-send -u normal -i "dialog-information" "$full_title" "$message"
   fi
  fi
 fi
}

# --- Function to ensure flavor list file exists ---
ensure_flavor_list() {
 if [ ! -f "$FLAVOR_LIST_FILE" ]; then
  echo "[]" > "$FLAVOR_LIST_FILE"
 fi
}

# --- Function to add flavor to list ---
add_flavor_to_list() {
 local new_flavor="$1"
 ensure_flavor_list
 # Check if flavor already exists
 if jq -e --arg flavor "$new_flavor" 'index($flavor) != null' "$FLAVOR_LIST_FILE" > /dev/null 2>&1; then
  return 0
 fi
 # Add flavor to list
 jq --arg flavor "$new_flavor" '. + [$flavor]' "$FLAVOR_LIST_FILE" > "$FLAVOR_LIST_FILE.tmp" && mv "$FLAVOR_LIST_FILE.tmp" "$FLAVOR_LIST_FILE"
 echo ":white_check_mark: Flavor '$new_flavor' added to history!"
}

# --- Function to check FVM choice ---
select_fvm() {
 echo "Would you like to use FVM (Flutter Version Manager)?"
 echo "1. Yes, use FVM"
 echo "2. No, use the default Flutter"
 read -p "Enter your choice [1-2]: " fvm_choice
 case $fvm_choice in
 1)
  FLUTTER_CMD="fvm flutter"
  validate_flutter_installation "fvm"
  echo "Using FVM for Flutter commands."
  ;;
 2)
  FLUTTER_CMD="flutter"
  validate_flutter_installation "flutter"
  echo "Using default Flutter command."
  ;;
 *)
  echo ":x: Invalid option! Defaulting to using the default Flutter command."
  FLUTTER_CMD="flutter"
  validate_flutter_installation "flutter"
  ;;
 esac
}

# --- Function to prompt for flavor with history ---
prompt_flavor() {
 ensure_flavor_list
 echo ""
 echo "═══════════════════════════════════════"
 echo "        SELECT BUILD FLAVOR"
 echo "═══════════════════════════════════════"
 # Read saved flavors
 local flavors=($(jq -r '.[]' "$FLAVOR_LIST_FILE" 2>/dev/null || echo ""))
 if [ "${#flavors[@]}" -gt 0 ]; then
  echo ":clipboard: Saved flavors:"
  i=1
  for flavor in "${flavors[@]}"; do
   # Mark last used flavor
   if [ -f "$FLAVOR_FILE" ] && [ "$flavor" = "$(cat "$FLAVOR_FILE")" ]; then
    echo "  $i) $flavor :star: (last used)"
   else
    echo "  $i) $flavor"
   fi
   ((i++))
  done
  echo "  0) No flavor (skip)"
  echo "  +) Add new flavor"
  echo ""
  read -p "Enter your choice [0-${#flavors[@]} or +]: " choice
  if [ "$choice" = "+" ]; then
   read -p "Enter new flavor name: " new_flavor_name
   if [ -n "$new_flavor_name" ]; then
    add_flavor_to_list "$new_flavor_name"
    FLAVOR_NAME="$new_flavor_name"
    FLAVOR_FLAGS="--flavor $FLAVOR_NAME --dart-define=FLAVOR=$FLAVOR_NAME"
    echo "$FLAVOR_NAME" > "$FLAVOR_FILE"
    echo ":white_check_mark: Building with flavor: $FLAVOR_NAME"
   else
    echo ":x: Flavor name cannot be empty!"
    prompt_flavor
    return
   fi
  elif [ "$choice" = "0" ]; then
   FLAVOR_FLAGS=""
   FLAVOR_NAME=""
   echo ":white_check_mark: Building without flavor"
  elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#flavors[@]}" ]; then
   FLAVOR_NAME="${flavors[$((choice-1))]}"
   FLAVOR_FLAGS="--flavor $FLAVOR_NAME --dart-define=FLAVOR=$FLAVOR_NAME"
   echo "$FLAVOR_NAME" > "$FLAVOR_FILE"
   echo ":white_check_mark: Building with flavor: $FLAVOR_NAME"
  else
   echo ":x: Invalid choice!"
   prompt_flavor
   return
  fi
 else
  echo ":information_source:  No saved flavors found."
  echo ""
  read -p "Enter flavor name (press Enter to skip): " FLAVOR_NAME
  if [ -z "$FLAVOR_NAME" ]; then
   FLAVOR_FLAGS=""
   echo ":white_check_mark: Building without flavor"
  else
   add_flavor_to_list "$FLAVOR_NAME"
   FLAVOR_FLAGS="--flavor $FLAVOR_NAME --dart-define=FLAVOR=$FLAVOR_NAME"
   echo "$FLAVOR_NAME" > "$FLAVOR_FILE"
   echo ":white_check_mark: Building with flavor: $FLAVOR_NAME"
  fi
 fi
 echo "═══════════════════════════════════════"
 echo ""
 
 # Validate selected flavor exists in current project
 if [ -n "$FLAVOR_NAME" ]; then
  if ! validate_flavor "$FLAVOR_NAME"; then
   echo ":x: Error: Flavor '$FLAVOR_NAME' does not exist in the current project!"
   echo "Please check your Android build.gradle or iOS configuration."
   exit 1
  fi
 fi
}

# --- Function to select multiple flavors ---
prompt_multiple_flavors() {
 ensure_flavor_list
 echo ""
 echo "═══════════════════════════════════════"
 echo "    SELECT MULTIPLE BUILD FLAVORS"
 echo "═══════════════════════════════════════"
 # Read saved flavors
 local flavors=($(jq -r '.[]' "$FLAVOR_LIST_FILE" 2>/dev/null || echo ""))
 if [ "${#flavors[@]}" -eq 0 ]; then
  echo ":x: No saved flavors found. Please add flavors first."
  return 1
 fi
 
 echo ":clipboard: Available flavors:"
 i=1
 for flavor in "${flavors[@]}"; do
  echo "  $i) $flavor"
  ((i++))
 done
 echo ""
 echo "Enter flavor numbers separated by spaces (e.g., 1 3 5)"
 echo "Or enter 'all' to build all flavors"
 echo "Or enter '+' to add a new flavor"
 read -p "Your selection: " selection
 
 SELECTED_FLAVORS=()
 
 if [ "$selection" = "all" ]; then
  SELECTED_FLAVORS=("${flavors[@]}")
  echo ":white_check_mark: Selected all flavors: ${SELECTED_FLAVORS[*]}"
 elif [ "$selection" = "+" ]; then
  read -p "Enter new flavor name: " new_flavor_name
  if [ -z "$new_flavor_name" ]; then
   echo ":x: Flavor name cannot be empty!"
   # Show list again
   prompt_multiple_flavors
   return
  fi
  add_flavor_to_list "$new_flavor_name"
  echo ":white_check_mark: Flavor '$new_flavor_name' added to history!"
  echo ""
  # Show the list again so user can select flavors
  prompt_multiple_flavors
  return
 else
  for num in $selection; do
   if [[ "$num" =~ ^[0-9]+$ ]] && [ "$num" -ge 1 ] && [ "$num" -le "${#flavors[@]}" ]; then
    SELECTED_FLAVORS+=("${flavors[$((num-1))]}")
   else
    echo ":warning: Skipping invalid selection: $num"
   fi
  done
  
  if [ "${#SELECTED_FLAVORS[@]}" -eq 0 ]; then
   echo ":x: No valid flavors selected!"
   return 1
  fi
  
  echo ":white_check_mark: Selected flavors: ${SELECTED_FLAVORS[*]}"
 fi
 
 # Validate and filter flavors that exist in current project
 local original_count=${#SELECTED_FLAVORS[@]}
 VALID_FLAVORS=()
 for flavor in "${SELECTED_FLAVORS[@]}"; do
  if validate_flavor "$flavor"; then
   VALID_FLAVORS+=("$flavor")
  else
   echo ":warning: Flavor '$flavor' does not exist in current project. Removing from selection."
  fi
 done
 
 # Update SELECTED_FLAVORS with only valid flavors
 SELECTED_FLAVORS=("${VALID_FLAVORS[@]}")
 
 # Check if any valid flavors remain
 if [ "${#SELECTED_FLAVORS[@]}" -eq 0 ]; then
  echo ":x: Error: No valid flavors found in the current project!"
  echo "All selected flavors were removed. Please check your project configuration."
  return 1
 fi
 
 # Show message if some flavors were filtered out
 if [ "${#SELECTED_FLAVORS[@]}" -lt "$original_count" ]; then
  echo ":white_check_mark: Valid flavors after filtering: ${SELECTED_FLAVORS[*]}"
 fi
 
 echo "═══════════════════════════════════════"
 echo ""
}

# --- Function: Clean Flutter general (shared) ---
clean_flutter() {
 echo ":arrows_counterclockwise: Cleaning Flutter project..."
 if ! $FLUTTER_CMD clean; then
  echo ":warning: Flutter clean had issues, but continuing..."
 fi
 if ! $FLUTTER_CMD pub get; then
  echo ":x: Failed to get dependencies!"
  return 1
 fi
}

# --- Function: Clean Android specific files ---
clean_android() {
 if [ ! -d "android" ]; then
  echo ":warning: Android directory not found. Skipping Android clean."
  return 0
 fi
 echo ":broom: Cleaning Android project..."
 cd android
 if [ -f "gradlew" ]; then
  ./gradlew clean
 else
  echo ":warning: gradlew not found. Skipping gradle clean."
 fi
 cd -
}

# --- Function: Clean iOS specific files ---
clean_ios() {
 if [ ! -d "ios" ]; then
  echo ":warning: iOS directory not found. Skipping iOS clean."
  return 0
 fi
 echo ":broom: Cleaning iOS pods..."
 cd ios
 if [ -f "Podfile" ]; then
  rm -rf Pods/ Podfile.lock
  pod install
 else
  echo ":warning: Podfile not found. Skipping pod operations."
 fi
 cd -
}

# --- Function: Build Android APK ---
build_android() {
 echo ":package: Building Android APK..."
 if $FLUTTER_CMD build apk $FLAVOR_FLAGS; then
  echo ":white_check_mark: APK build completed!"
  local flavor_msg=""
  if [ -n "$FLAVOR_NAME" ]; then
   flavor_msg=" (Flavor: $FLAVOR_NAME)"
  fi
  send_notification "Flutter Build" "Android APK build completed successfully!$flavor_msg"
 else
  send_notification "Flutter Build" "Android APK build failed!" "false"
  return 1
 fi
}

# --- Function: Build multiple Android APKs ---
build_multiple_android_apks() {
 echo ""
 echo ":rocket: Building multiple Android APKs..."
 echo ""
 
 # Create output directory for organized builds
 OUTPUT_DIR="build/app/outputs/flutter-apk/multi-flavor"
 mkdir -p "$OUTPUT_DIR"
 
 local success_count=0
 local total_count=${#SELECTED_FLAVORS[@]}
 BUILT_APKS=()
 
 for flavor in "${SELECTED_FLAVORS[@]}"; do
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":package: Building flavor: $flavor ($((success_count + 1))/$total_count)"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  if $FLUTTER_CMD build apk --flavor "$flavor" --dart-define=FLAVOR="$flavor"; then
   # Move and rename the APK
   source_apk="build/app/outputs/flutter-apk/app-${flavor}-release.apk"
   if [ -f "$source_apk" ]; then
    cp "$source_apk" "$OUTPUT_DIR/app-${flavor}-release.apk"
    BUILT_APKS+=("$OUTPUT_DIR/app-${flavor}-release.apk:$flavor")
    echo ":white_check_mark: APK for $flavor saved to $OUTPUT_DIR"
    ((success_count++))
   else
    echo ":warning: APK not found for $flavor at $source_apk"
   fi
  else
   echo ":x: Failed to build $flavor"
  fi
  echo ""
 done
 
 echo "═══════════════════════════════════════"
 echo ":tada: Multi-flavor build completed!"
 echo "Success: $success_count/$total_count"
 echo "Output directory: $OUTPUT_DIR"
 echo "═══════════════════════════════════════"
 
 # Send notification
 if [ "$success_count" -eq "$total_count" ]; then
  send_notification "Flutter Build" "All $total_count Android APK builds completed successfully!"
 elif [ "$success_count" -gt 0 ]; then
  send_notification "Flutter Build" "Multi-flavor build: $success_count/$total_count APKs built successfully" "false"
 else
  send_notification "Flutter Build" "Multi-flavor build failed!" "false"
 fi
}

# --- Function: Upload multiple APKs to Google Drive ---
upload_multiple_apks_to_drive() {
 echo ":lightning: Preparing to upload multiple APKs to Google Drive..."
 
 # Validate environment variable
 if [ -z "$GDRIVE_ACCOUNT_FILE" ]; then
  echo ":x: GDRIVE_ACCOUNT_FILE environment variable is not set!"
  echo "Please add 'export GDRIVE_ACCOUNT_FILE=your_file_path' to your ~/.zshrc"
  return 1
 fi
 
 # Install gdrive if not installed
 if ! command -v gdrive &> /dev/null; then
  echo ":arrow_down_small: Installing gdrive..."
  curl -L -o gdrive.tar.gz https://github.com/glotlabs/gdrive/releases/download/3.9.1/gdrive_linux-x64.tar.gz
  tar -xzf gdrive.tar.gz
  chmod +x gdrive
  sudo mv gdrive /usr/local/bin/
 fi
 
 # Check if gdrive account already exists
 if ! gdrive about &>/dev/null; then
  echo ":key: Importing gdrive account..."
  gdrive account import "$GDRIVE_ACCOUNT_FILE"
 else
  echo ":white_check_mark: gdrive account already imported."
 fi
 
 # Extract app version from pubspec.yaml
 app_version=""
 if [ -f "pubspec.yaml" ]; then
  app_version=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
  if [ -n "$app_version" ]; then
   echo ":label: App version: $app_version"
  fi
 fi
 
 date_str=$(date +%d-%m-%Y)
 local upload_count=0
 UPLOAD_LINKS=()
 
 for apk_info in "${BUILT_APKS[@]}"; do
  apk_path="${apk_info%%:*}"
  flavor_name="${apk_info##*:}"
  
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":arrow_up_small: Uploading flavor: $flavor_name"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  # Build filename
  filename_parts="${APP_NAME}"
  if [ -n "$CUSTOM_NAME" ]; then
   filename_parts="${filename_parts} ${CUSTOM_NAME}"
  fi
  filename_parts="${filename_parts} ${flavor_name}"
  
  if [ -n "$app_version" ]; then
   renamed_apk="${apk_path%/*}/${filename_parts} v${app_version} (${date_str}).apk"
  else
   renamed_apk="${apk_path%/*}/${filename_parts} (${date_str}).apk"
  fi
  
  if [ ! -f "$apk_path" ]; then
   echo ":x: APK not found at $apk_path"
   continue
  fi
  
  cp "$apk_path" "$renamed_apk"
  
  echo "Uploading: $(basename "$renamed_apk")"
  upload_output=$(gdrive files upload --parent "$GDRIVE_FOLDER_ID" "$renamed_apk" 2>&1)
  upload_exit_code=$?
  
  # Check if upload failed
  if [ $upload_exit_code -ne 0 ]; then
   echo ":x: Upload failed for $flavor_name (exit code: $upload_exit_code)"
   rm "$renamed_apk"
   continue
  fi
  
  # Extract file ID from the upload output
  file_id=$(echo "$upload_output" | grep 'Id:' | awk '{print $2}')
  
  if [ -z "$file_id" ]; then
   echo ":x: Failed to retrieve file ID for $flavor_name"
   rm "$renamed_apk"
   continue
  fi
  
  gdrive permissions share "$file_id" > /dev/null 2>&1
  file_url="https://drive.google.com/file/d/$file_id/view"
  
  echo ":white_check_mark: Uploaded: $flavor_name"
  echo ":link: Link: $file_url"
  
  UPLOAD_LINKS+=("$flavor_name: $file_url")
  
  # Delete renamed APK
  rm "$renamed_apk"
  ((upload_count++))
 done
 
 echo ""
 echo "═══════════════════════════════════════"
 echo ":tada: Upload completed!"
 echo "Uploaded: $upload_count/${#BUILT_APKS[@]}"
 echo "═══════════════════════════════════════"
 echo ""
 echo ":link: Download Links:"
 for link in "${UPLOAD_LINKS[@]}"; do
  echo "  • $link"
 done
 echo ""
 
 # Copy all links to clipboard
 all_links=$(printf "%s\n" "${UPLOAD_LINKS[@]}")
 if command -v pbcopy &>/dev/null; then
  echo "$all_links" | pbcopy
  echo ":clipboard: All links copied to clipboard!"
 elif command -v xclip &>/dev/null; then
  echo "$all_links" | xclip -selection clipboard
  echo ":clipboard: All links copied to clipboard!"
 elif command -v xsel &>/dev/null; then
  echo "$all_links" | xsel --clipboard --input
  echo ":clipboard: All links copied to clipboard!"
 fi
 
 # Send notification
 if [ "$upload_count" -eq "${#BUILT_APKS[@]}" ]; then
  send_notification "Google Drive Upload" "All $upload_count APKs uploaded successfully!"
 elif [ "$upload_count" -gt 0 ]; then
  send_notification "Google Drive Upload" "Uploaded $upload_count/${#BUILT_APKS[@]} APKs" "false"
 else
  send_notification "Google Drive Upload" "Upload failed!" "false"
 fi
}

# --- Function: Build multiple Android App Bundles ---
build_multiple_appbundles() {
 echo ""
 echo ":rocket: Building multiple Android App Bundles..."
 echo ""
 
 # Create output directory for organized builds
 OUTPUT_DIR="build/app/outputs/bundle/multi-flavor"
 mkdir -p "$OUTPUT_DIR"
 
 local success_count=0
 local total_count=${#SELECTED_FLAVORS[@]}
 BUILT_APPBUNDLES=()
 
 for flavor in "${SELECTED_FLAVORS[@]}"; do
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":package: Building App Bundle for flavor: $flavor ($((success_count + 1))/$total_count)"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  if $FLUTTER_CMD build appbundle --flavor "$flavor" --dart-define=FLAVOR="$flavor"; then
   # Move and rename the App Bundle
   source_aab="build/app/outputs/bundle/${flavor}Release/app-${flavor}-release.aab"
   if [ -f "$source_aab" ]; then
    cp "$source_aab" "$OUTPUT_DIR/app-${flavor}-release.aab"
    BUILT_APPBUNDLES+=("$OUTPUT_DIR/app-${flavor}-release.aab:$flavor")
    echo ":white_check_mark: App Bundle for $flavor saved to $OUTPUT_DIR"
    ((success_count++))
   else
    echo ":warning: App Bundle not found for $flavor at $source_aab"
   fi
  else
   echo ":x: Failed to build App Bundle for $flavor"
  fi
  echo ""
 done
 
 echo "═══════════════════════════════════════"
 echo ":tada: Multi-flavor App Bundle build completed!"
 echo "Success: $success_count/$total_count"
 echo "Output directory: $OUTPUT_DIR"
 echo "═══════════════════════════════════════"
 
 # Send notification
 if [ "$success_count" -eq "$total_count" ]; then
  send_notification "Flutter Build" "All $total_count Android App Bundle builds completed successfully!"
 elif [ "$success_count" -gt 0 ]; then
  send_notification "Flutter Build" "Multi-flavor build: $success_count/$total_count App Bundles built successfully" "false"
 else
  send_notification "Flutter Build" "Multi-flavor App Bundle build failed!" "false"
 fi
}

# --- Function: Upload multiple App Bundles to Google Drive ---
upload_multiple_appbundles_to_drive() {
 echo ":lightning: Preparing to upload multiple App Bundles to Google Drive..."
 
 # Validate environment variable
 if [ -z "$GDRIVE_ACCOUNT_FILE" ]; then
  echo ":x: GDRIVE_ACCOUNT_FILE environment variable is not set!"
  echo "Please add 'export GDRIVE_ACCOUNT_FILE=your_file_path' to your ~/.zshrc"
  return 1
 fi
 
 # Install gdrive if not installed
 if ! command -v gdrive &> /dev/null; then
  echo ":arrow_down_small: Installing gdrive..."
  curl -L -o gdrive.tar.gz https://github.com/glotlabs/gdrive/releases/download/3.9.1/gdrive_linux-x64.tar.gz
  tar -xzf gdrive.tar.gz
  chmod +x gdrive
  sudo mv gdrive /usr/local/bin/
 fi
 
 # Check if gdrive account already exists
 if ! gdrive about &>/dev/null; then
  echo ":key: Importing gdrive account..."
  gdrive account import "$GDRIVE_ACCOUNT_FILE"
 else
  echo ":white_check_mark: gdrive account already imported."
 fi
 
 # Extract app version from pubspec.yaml
 app_version=""
 if [ -f "pubspec.yaml" ]; then
  app_version=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
  if [ -n "$app_version" ]; then
   echo ":label: App version: $app_version"
  fi
 fi
 
 date_str=$(date +%d-%m-%Y)
 local upload_count=0
 UPLOAD_LINKS=()
 
 for aab_info in "${BUILT_APPBUNDLES[@]}"; do
  aab_path="${aab_info%%:*}"
  flavor_name="${aab_info##*:}"
  
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":arrow_up_small: Uploading flavor: $flavor_name"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  # Build filename
  filename_parts="${APP_NAME}"
  if [ -n "$CUSTOM_NAME" ]; then
   filename_parts="${filename_parts} ${CUSTOM_NAME}"
  fi
  filename_parts="${filename_parts} ${flavor_name}"
  
  if [ -n "$app_version" ]; then
   renamed_aab="${aab_path%/*}/${filename_parts} v${app_version} (${date_str}).aab"
  else
   renamed_aab="${aab_path%/*}/${filename_parts} (${date_str}).aab"
  fi
  
  if [ ! -f "$aab_path" ]; then
   echo ":x: App Bundle not found at $aab_path"
   continue
  fi
  
  cp "$aab_path" "$renamed_aab"
  
  echo "Uploading: $(basename "$renamed_aab")"
  upload_output=$(gdrive files upload --parent "$GDRIVE_FOLDER_ID" "$renamed_aab" 2>&1)
  upload_exit_code=$?
  
  # Check if upload failed
  if [ $upload_exit_code -ne 0 ]; then
   echo ":x: Upload failed for $flavor_name (exit code: $upload_exit_code)"
   rm "$renamed_aab"
   continue
  fi
  
  # Extract file ID from the upload output
  file_id=$(echo "$upload_output" | grep 'Id:' | awk '{print $2}')
  
  if [ -z "$file_id" ]; then
   echo ":x: Failed to retrieve file ID for $flavor_name"
   rm "$renamed_aab"
   continue
  fi
  
  gdrive permissions share "$file_id" > /dev/null 2>&1
  file_url="https://drive.google.com/file/d/$file_id/view"
  
  echo ":white_check_mark: Uploaded: $flavor_name"
  echo ":link: Link: $file_url"
  
  UPLOAD_LINKS+=("$flavor_name: $file_url")
  
  # Delete renamed App Bundle
  rm "$renamed_aab"
  ((upload_count++))
 done
 
 echo ""
 echo "═══════════════════════════════════════"
 echo ":tada: Upload completed!"
 echo "Uploaded: $upload_count/${#BUILT_APPBUNDLES[@]}"
 echo "═══════════════════════════════════════"
 echo ""
 echo ":link: Download Links:"
 for link in "${UPLOAD_LINKS[@]}"; do
  echo "  • $link"
 done
 echo ""
 
 # Copy all links to clipboard
 all_links=$(printf "%s\n" "${UPLOAD_LINKS[@]}")
 if command -v pbcopy &>/dev/null; then
  echo "$all_links" | pbcopy
  echo ":clipboard: All links copied to clipboard!"
 elif command -v xclip &>/dev/null; then
  echo "$all_links" | xclip -selection clipboard
  echo ":clipboard: All links copied to clipboard!"
 elif command -v xsel &>/dev/null; then
  echo "$all_links" | xsel --clipboard --input
  echo ":clipboard: All links copied to clipboard!"
 fi
 
 # Send notification
 if [ "$upload_count" -eq "${#BUILT_APPBUNDLES[@]}" ]; then
  send_notification "Google Drive Upload" "All $upload_count App Bundles uploaded successfully!"
 elif [ "$upload_count" -gt 0 ]; then
  send_notification "Google Drive Upload" "Uploaded $upload_count/${#BUILT_APPBUNDLES[@]} App Bundles" "false"
 else
  send_notification "Google Drive Upload" "Upload failed!" "false"
 fi
}

# --- Function: Build multiple iOS IPAs ---
build_multiple_ios_ipas() {
 echo ""
 echo ":rocket: Building multiple iOS IPAs..."
 echo ""
 
 # Create output directory for organized builds
 OUTPUT_DIR="build/ios/ipa/multi-flavor"
 mkdir -p "$OUTPUT_DIR"
 
 local success_count=0
 local total_count=${#SELECTED_FLAVORS[@]}
 BUILT_IPAS=()
 
 for flavor in "${SELECTED_FLAVORS[@]}"; do
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":package: Building flavor: $flavor ($((success_count + 1))/$total_count)"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  if $FLUTTER_CMD build ipa --flavor "$flavor" --dart-define=FLAVOR="$flavor"; then
   # Find and move the IPA (iOS uses a different structure)
   source_ipa=$(find build/ios/ipa -name "*.ipa" -type f | head -n 1)
   if [ -n "$source_ipa" ]; then
    cp "$source_ipa" "$OUTPUT_DIR/app-${flavor}.ipa"
    BUILT_IPAS+=("$OUTPUT_DIR/app-${flavor}.ipa:$flavor")
    echo ":white_check_mark: IPA for $flavor saved to $OUTPUT_DIR"
    ((success_count++))
   else
    echo ":warning: IPA not found for $flavor"
   fi
  else
   echo ":x: Failed to build $flavor"
  fi
  echo ""
 done
 
 echo "═══════════════════════════════════════"
 echo ":tada: Multi-flavor build completed!"
 echo "Success: $success_count/$total_count"
 echo "Output directory: $OUTPUT_DIR"
 echo "═══════════════════════════════════════"
 
 # Send notification
 if [ "$success_count" -eq "$total_count" ]; then
  send_notification "Flutter Build" "All $total_count iOS IPA builds completed successfully!"
 elif [ "$success_count" -gt 0 ]; then
  send_notification "Flutter Build" "Multi-flavor build: $success_count/$total_count IPAs built successfully" "false"
 else
  send_notification "Flutter Build" "Multi-flavor iOS IPA build failed!" "false"
 fi
}

PROJECTS_FILE="$HOME/.apk_uploader_projects.json"

ensure_projects_file() {
 if [ ! -f "$PROJECTS_FILE" ]; then
  echo "{}" > "$PROJECTS_FILE"
 fi
}

choose_project() {
 ensure_projects_file
 local ids=($(jq -r 'keys[]' "$PROJECTS_FILE"))
 if [ "${#ids[@]}" -eq 0 ]; then
  echo ":memo: No saved projects found. Let's add one."
  add_new_project
  return
 fi
 echo ":rocket: Choose your app to upload:"
 i=1
 for folder_id in "${ids[@]}"; do
  app_name=$(jq -r --arg id "$folder_id" '.[$id]' "$PROJECTS_FILE")
  echo "$i) $app_name [$folder_id]"
  ((i++))
 done
 echo ":heavy_plus_sign: Add a new project"
 read -p "Enter your choice [1-${#ids[@]} or +]: " choice
 if [ "$choice" = "+" ]; then
  add_new_project
 elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#ids[@]}" ]; then
  GDRIVE_FOLDER_ID="${ids[$((choice-1))]}"
  APP_NAME=$(jq -r --arg id "$GDRIVE_FOLDER_ID" '.[$id]' "$PROJECTS_FILE")
 else
  echo ":x: Invalid choice."
  return 1
 fi
}

add_new_project() {
 read -p "Enter Google Drive Folder ID: " new_folder_id
 read -p "Enter App Name: " new_app_name
 # Check if folder ID already exists
 if jq -e --arg id "$new_folder_id" 'has($id)' "$PROJECTS_FILE" > /dev/null; then
  echo ":warning:  This folder ID is already saved."
  return 1
 fi
 jq --arg id "$new_folder_id" --arg name "$new_app_name" '. + {($id): $name}' "$PROJECTS_FILE" > "$PROJECTS_FILE.tmp" && mv "$PROJECTS_FILE.tmp" "$PROJECTS_FILE"
 GDRIVE_FOLDER_ID="$new_folder_id"
 APP_NAME="$new_app_name"
 echo ":white_check_mark: Project saved!"
}

# --- Function: Upload APK to Google Drive ---
upload_apk_to_drive() {
 echo ":lightning:  Preparing to upload APK to Google Drive..."
 # Validate environment variable
 if [ -z "$GDRIVE_ACCOUNT_FILE" ]; then
  echo ":x: GDRIVE_ACCOUNT_FILE environment variable is not set!"
  echo "Please add 'export GDRIVE_ACCOUNT_FILE=your_file_path' to your ~/.zshrc"
  return 1
 fi
 # Install gdrive if not installed
 if ! command -v gdrive &> /dev/null; then
  echo ":arrow_down_small:  Installing gdrive..."
  curl -L -o gdrive.tar.gz https://github.com/glotlabs/gdrive/releases/download/3.9.1/gdrive_linux-x64.tar.gz
  tar -xzf gdrive.tar.gz
  chmod +x gdrive
  sudo mv gdrive /usr/local/bin/
 fi
 # Check if gdrive account already exists
 if ! gdrive about &>/dev/null; then
  echo ":key: Importing gdrive account..."
  gdrive account import "$GDRIVE_ACCOUNT_FILE"
 else
  echo ":white_check_mark: gdrive account already imported."
 fi
 
 # Extract app version from pubspec.yaml
 app_version=""
 if [ -f "pubspec.yaml" ]; then
  app_version=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
  if [ -n "$app_version" ]; then
   echo ":label: App version: $app_version"
  fi
 fi
 
 # Determine APK path based on flavor
 if [ -z "$FLAVOR_NAME" ]; then
  apk_path="build/app/outputs/flutter-apk/app-release.apk"
 else
  apk_path="build/app/outputs/flutter-apk/app-${FLAVOR_NAME}-release.apk"
 fi
 date_str=$(date +%d-%m-%Y)
 # Build filename with custom name, flavor, and version
 filename_parts="${APP_NAME}"
 if [ -n "$CUSTOM_NAME" ]; then
  filename_parts="${filename_parts} ${CUSTOM_NAME}"
 fi
 if [ -n "$FLAVOR_NAME" ]; then
  filename_parts="${filename_parts} ${FLAVOR_NAME}"
 fi
 if [ -n "$app_version" ]; then
  renamed_apk="build/app/outputs/flutter-apk/${filename_parts} v${app_version} (${date_str}).apk"
 else
  renamed_apk="build/app/outputs/flutter-apk/${filename_parts} (${date_str}).apk"
 fi
 if [ ! -f "$apk_path" ]; then
  echo ":x: APK not found at $apk_path"
  return 1
 fi
 mv "$apk_path" "$renamed_apk"
 echo ":arrow_up_small: Uploading $renamed_apk..."
 upload_output=$(gdrive files upload --parent "$GDRIVE_FOLDER_ID" "$renamed_apk" 2>&1)
 upload_exit_code=$?
 echo "$upload_output"
 
 # Check if upload failed
 if [ $upload_exit_code -ne 0 ]; then
  echo ":x: Upload failed with exit code $upload_exit_code"
  send_notification "Google Drive Upload" "APK upload failed!" "false"
  return 1
 fi
 
 # Extract file ID from the upload output
 file_id=$(echo "$upload_output" | grep 'Id:' | awk '{print $2}')
 if [ -z "$file_id" ]; then
  echo ":x: Failed to retrieve file ID from upload output."
  send_notification "Google Drive Upload" "APK upload failed - could not get file ID!" "false"
  return 1
 fi
 
 share_output=$(gdrive permissions share "$file_id" 2>&1)
 share_exit_code=$?
 echo "$share_output"
 
 if [ $share_exit_code -ne 0 ]; then
  echo ":warning: Failed to share file, but upload may have succeeded."
 fi
 
 file_url="https://drive.google.com/file/d/$file_id/view"
 echo ":link: Download Link: $file_url"

 if command -v pbcopy &>/dev/null; then
  echo "$file_url" | pbcopy
  echo ":clipboard:  Link copied to clipboard!"
 elif command -v xclip &>/dev/null; then
  echo "$file_url" | xclip -selection clipboard
  echo ":clipboard:  Link copied to clipboard!"
 elif command -v xsel &>/dev/null; then
  echo "$file_url" | xsel --clipboard --input
  echo ":clipboard:  Link copied to clipboard!"
 else
  echo ":warning: Clipboard tool not found. Install pbcopy/xclip/xsel to auto-copy."
 fi

 # Delete local APK file after successful upload
 echo ":wastebasket:  Deleting local APK file..."
 if rm "$renamed_apk"; then
  echo ":white_check_mark: Local APK file deleted successfully!"
 else
  echo ":warning:  Failed to delete local APK file."
 fi
 
 # Send notification
 local flavor_msg=""
 if [ -n "$FLAVOR_NAME" ]; then
  flavor_msg=" (Flavor: $FLAVOR_NAME)"
 fi
 send_notification "Google Drive Upload" "APK uploaded successfully!$flavor_msg"
}

# --- Function: Build Android App Bundle ---
build_appbundle() {
 echo ":package: Building Android App Bundle..."
 if $FLUTTER_CMD build appbundle $FLAVOR_FLAGS; then
  echo ":white_check_mark: App Bundle build completed!"
  local flavor_msg=""
  if [ -n "$FLAVOR_NAME" ]; then
   flavor_msg=" (Flavor: $FLAVOR_NAME)"
  fi
  send_notification "Flutter Build" "Android App Bundle build completed successfully!$flavor_msg"
 else
  send_notification "Flutter Build" "Android App Bundle build failed!" "false"
  return 1
 fi
}

# --- Function: Build iOS IPA ---
build_ios() {
 echo ":package: Building iOS IPA..."
 if $FLUTTER_CMD build ipa $FLAVOR_FLAGS; then
  echo ":white_check_mark: IPA build completed!"
  local flavor_msg=""
  if [ -n "$FLAVOR_NAME" ]; then
   flavor_msg=" (Flavor: $FLAVOR_NAME)"
  fi
  send_notification "Flutter Build" "iOS IPA build completed successfully!$flavor_msg"
 else
  send_notification "Flutter Build" "iOS IPA build failed!" "false"
  return 1
 fi
}

# --- Function: Upload iOS IPA to Google Drive ---
upload_ios_ipa_to_drive() {
 echo ":lightning:  Preparing to upload iOS IPA to Google Drive..."
 # Validate environment variable
 if [ -z "$GDRIVE_ACCOUNT_FILE" ]; then
  echo ":x: GDRIVE_ACCOUNT_FILE environment variable is not set!"
  echo "Please add 'export GDRIVE_ACCOUNT_FILE=your_file_path' to your ~/.zshrc"
  return 1
 fi
 # Install gdrive if not installed
 if ! command -v gdrive &> /dev/null; then
  echo ":arrow_down_small:  Installing gdrive..."
  curl -L -o gdrive.tar.gz https://github.com/glotlabs/gdrive/releases/download/3.9.1/gdrive_linux-x64.tar.gz
  tar -xzf gdrive.tar.gz
  chmod +x gdrive
  sudo mv gdrive /usr/local/bin/
 fi
 # Check if gdrive account already exists
 if ! gdrive about &>/dev/null; then
  echo ":key: Importing gdrive account..."
  gdrive account import "$GDRIVE_ACCOUNT_FILE"
 else
  echo ":white_check_mark: gdrive account already imported."
 fi
 
 # Extract app version from pubspec.yaml
 app_version=""
 if [ -f "pubspec.yaml" ]; then
  app_version=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
  if [ -n "$app_version" ]; then
   echo ":label: App version: $app_version"
  fi
 fi
 
 # Find IPA file (iOS uses a different structure)
 ipa_path=$(find build/ios/ipa -name "*.ipa" -type f | head -n 1)
 if [ -z "$ipa_path" ]; then
  echo ":x: IPA not found in build/ios/ipa/"
  return 1
 fi
 
 date_str=$(date +%d-%m-%Y)
 # Build filename with custom name, flavor, and version
 filename_parts="${APP_NAME}"
 if [ -n "$CUSTOM_NAME" ]; then
  filename_parts="${filename_parts} ${CUSTOM_NAME}"
 fi
 if [ -n "$FLAVOR_NAME" ]; then
  filename_parts="${filename_parts} ${FLAVOR_NAME}"
 fi
 if [ -n "$app_version" ]; then
  renamed_ipa="build/ios/ipa/${filename_parts} v${app_version} (${date_str}).ipa"
 else
  renamed_ipa="build/ios/ipa/${filename_parts} (${date_str}).ipa"
 fi
 
 cp "$ipa_path" "$renamed_ipa"
 echo ":arrow_up_small: Uploading $renamed_ipa..."
 upload_output=$(gdrive files upload --parent "$GDRIVE_FOLDER_ID" "$renamed_ipa" 2>&1)
 upload_exit_code=$?
 echo "$upload_output"
 
 # Check if upload failed
 if [ $upload_exit_code -ne 0 ]; then
  echo ":x: Upload failed with exit code $upload_exit_code"
  send_notification "Google Drive Upload" "iOS IPA upload failed!" "false"
  rm "$renamed_ipa"
  return 1
 fi
 
 # Extract file ID from the upload output
 file_id=$(echo "$upload_output" | grep 'Id:' | awk '{print $2}')
 if [ -z "$file_id" ]; then
  echo ":x: Failed to retrieve file ID from upload output."
  send_notification "Google Drive Upload" "iOS IPA upload failed - could not get file ID!" "false"
  rm "$renamed_ipa"
  return 1
 fi
 
 share_output=$(gdrive permissions share "$file_id" 2>&1)
 share_exit_code=$?
 echo "$share_output"
 
 if [ $share_exit_code -ne 0 ]; then
  echo ":warning: Failed to share file, but upload may have succeeded."
 fi
 
 file_url="https://drive.google.com/file/d/$file_id/view"
 echo ":link: Download Link: $file_url"

 if command -v pbcopy &>/dev/null; then
  echo "$file_url" | pbcopy
  echo ":clipboard:  Link copied to clipboard!"
 elif command -v xclip &>/dev/null; then
  echo "$file_url" | xclip -selection clipboard
  echo ":clipboard:  Link copied to clipboard!"
 elif command -v xsel &>/dev/null; then
  echo "$file_url" | xsel --clipboard --input
  echo ":clipboard:  Link copied to clipboard!"
 else
  echo ":warning: Clipboard tool not found. Install pbcopy/xclip/xsel to auto-copy."
 fi

 # Delete local IPA file after successful upload
 echo ":wastebasket:  Deleting local IPA file..."
 if rm "$renamed_ipa"; then
  echo ":white_check_mark: Local IPA file deleted successfully!"
 else
  echo ":warning:  Failed to delete local IPA file."
 fi
 
 # Send notification
 local flavor_msg=""
 if [ -n "$FLAVOR_NAME" ]; then
  flavor_msg=" (Flavor: $FLAVOR_NAME)"
 fi
 send_notification "Google Drive Upload" "iOS IPA uploaded successfully!$flavor_msg"
}

# --- Function: Upload multiple iOS IPAs to Google Drive ---
upload_multiple_ios_ipas_to_drive() {
 echo ":lightning: Preparing to upload multiple iOS IPAs to Google Drive..."
 
 # Validate environment variable
 if [ -z "$GDRIVE_ACCOUNT_FILE" ]; then
  echo ":x: GDRIVE_ACCOUNT_FILE environment variable is not set!"
  echo "Please add 'export GDRIVE_ACCOUNT_FILE=your_file_path' to your ~/.zshrc"
  return 1
 fi
 
 # Install gdrive if not installed
 if ! command -v gdrive &> /dev/null; then
  echo ":arrow_down_small: Installing gdrive..."
  curl -L -o gdrive.tar.gz https://github.com/glotlabs/gdrive/releases/download/3.9.1/gdrive_linux-x64.tar.gz
  tar -xzf gdrive.tar.gz
  chmod +x gdrive
  sudo mv gdrive /usr/local/bin/
 fi
 
 # Check if gdrive account already exists
 if ! gdrive about &>/dev/null; then
  echo ":key: Importing gdrive account..."
  gdrive account import "$GDRIVE_ACCOUNT_FILE"
 else
  echo ":white_check_mark: gdrive account already imported."
 fi
 
 # Extract app version from pubspec.yaml
 app_version=""
 if [ -f "pubspec.yaml" ]; then
  app_version=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
  if [ -n "$app_version" ]; then
   echo ":label: App version: $app_version"
  fi
 fi
 
 date_str=$(date +%d-%m-%Y)
 local upload_count=0
 UPLOAD_LINKS=()
 
 for ipa_info in "${BUILT_IPAS[@]}"; do
  ipa_path="${ipa_info%%:*}"
  flavor_name="${ipa_info##*:}"
  
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":arrow_up_small: Uploading flavor: $flavor_name"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  # Build filename
  filename_parts="${APP_NAME}"
  if [ -n "$CUSTOM_NAME" ]; then
   filename_parts="${filename_parts} ${CUSTOM_NAME}"
  fi
  filename_parts="${filename_parts} ${flavor_name}"
  
  if [ -n "$app_version" ]; then
   renamed_ipa="${ipa_path%/*}/${filename_parts} v${app_version} (${date_str}).ipa"
  else
   renamed_ipa="${ipa_path%/*}/${filename_parts} (${date_str}).ipa"
  fi
  
  if [ ! -f "$ipa_path" ]; then
   echo ":x: IPA not found at $ipa_path"
   continue
  fi
  
  cp "$ipa_path" "$renamed_ipa"
  
  echo "Uploading: $(basename "$renamed_ipa")"
  upload_output=$(gdrive files upload --parent "$GDRIVE_FOLDER_ID" "$renamed_ipa" 2>&1)
  upload_exit_code=$?
  
  # Check if upload failed
  if [ $upload_exit_code -ne 0 ]; then
   echo ":x: Upload failed for $flavor_name (exit code: $upload_exit_code)"
   rm "$renamed_ipa"
   continue
  fi
  
  # Extract file ID from the upload output
  file_id=$(echo "$upload_output" | grep 'Id:' | awk '{print $2}')
  
  if [ -z "$file_id" ]; then
   echo ":x: Failed to retrieve file ID for $flavor_name"
   rm "$renamed_ipa"
   continue
  fi
  
  gdrive permissions share "$file_id" > /dev/null 2>&1
  file_url="https://drive.google.com/file/d/$file_id/view"
  
  echo ":white_check_mark: Uploaded: $flavor_name"
  echo ":link: Link: $file_url"
  
  UPLOAD_LINKS+=("$flavor_name: $file_url")
  
  # Delete renamed IPA
  rm "$renamed_ipa"
  ((upload_count++))
 done
 
 echo ""
 echo "═══════════════════════════════════════"
 echo ":tada: Upload completed!"
 echo "Uploaded: $upload_count/${#BUILT_IPAS[@]}"
 echo "═══════════════════════════════════════"
 echo ""
 echo ":link: Download Links:"
 for link in "${UPLOAD_LINKS[@]}"; do
  echo "  • $link"
 done
 echo ""
 
 # Copy all links to clipboard
 all_links=$(printf "%s\n" "${UPLOAD_LINKS[@]}")
 if command -v pbcopy &>/dev/null; then
  echo "$all_links" | pbcopy
  echo ":clipboard: All links copied to clipboard!"
 elif command -v xclip &>/dev/null; then
  echo "$all_links" | xclip -selection clipboard
  echo ":clipboard: All links copied to clipboard!"
 elif command -v xsel &>/dev/null; then
  echo "$all_links" | xsel --clipboard --input
  echo ":clipboard: All links copied to clipboard!"
 fi
 
 # Send notification
 if [ "$upload_count" -eq "${#BUILT_IPAS[@]}" ]; then
  send_notification "Google Drive Upload" "All $upload_count iOS IPAs uploaded successfully!"
 elif [ "$upload_count" -gt 0 ]; then
  send_notification "Google Drive Upload" "Uploaded $upload_count/${#BUILT_IPAS[@]} iOS IPAs" "false"
 else
  send_notification "Google Drive Upload" "Upload failed!" "false"
 fi
}

# --- Validate we're in a Flutter project ---
validate_flutter_project

# --- First Menu: Select FVM ---
select_fvm

# --- Second Menu: Choose What to Do ---
show_menu() {
 echo ""
 echo "═══════════════════════════════════════"
 echo "     FLUTTER BUILD AUTOMATION MENU"
 echo "═══════════════════════════════════════"
 echo "1.  Clean and get dependencies Flutter"
 echo "2.  Clean Android project only"
 echo "3.  Clean iOS project only"
 echo "4.  Build Android APK"
 echo "5.  Build Android APK and Upload to Google Drive"
 echo "6.  Build Android App Bundle"
 echo "7.  Build iOS IPA"
 echo "8.  Build multiple Android APKs (multi-flavor)"
 echo "9.  Build multiple Android APKs and Upload (multi-flavor)"
 echo "10. Build multiple Android App Bundles (multi-flavor)"
 echo "11. Build multiple Android App Bundles and Upload (multi-flavor)"
 echo "12. Build multiple iOS IPAs (multi-flavor)"
 echo "13. Clean ALL (Flutter, Android, iOS)"
 echo "14. Build ALL (Android + iOS)"
 echo "15. Build iOS IPA and Upload to Google Drive"
 echo "16. Build multiple iOS IPAs and Upload (multi-flavor)"
 echo "17. Build APK + IPA and Upload to Google Drive"
 echo "18. Build ALL (Android + iOS) - Multiple Flavors"
 echo "19. Quit"
 echo "═══════════════════════════════════════"
 read -p "Enter your choice [1-19]: " choice
}

# --- Main Logic ---
while true; do
 show_menu
 case $choice in
 1)
  clean_flutter
  ;;
 2)
  clean_android
  ;;
 3)
  clean_ios
  ;;
 4)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  build_android
  ;;
 5)
  choose_project || break
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  build_android
  upload_apk_to_drive
  clean_flutter
  ;;
 6)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  build_appbundle
  ;;
 7)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  clean_ios
  build_ios
  ;;
 8)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  build_multiple_android_apks
  ;;
 9)
  choose_project || continue
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  build_multiple_android_apks
  upload_multiple_apks_to_drive
  clean_flutter
  ;;
 10)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  build_multiple_appbundles
  ;;
 11)
  choose_project || continue
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  build_multiple_appbundles
  upload_multiple_appbundles_to_drive
  clean_flutter
  ;;
 12)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  clean_ios
  build_multiple_ios_ipas
  ;;
 13)
  clean_flutter
  clean_android
  clean_ios
  ;;
 13)
  clean_flutter
  clean_android
  clean_ios
  ;;
 14)
  prompt_flavor
  echo ""
  echo "═══════════════════════════════════════"
  echo "      SELECT BUILD COMBINATION"
  echo "═══════════════════════════════════════"
  echo "1. APK + IPA"
  echo "2. App Bundle + IPA"
  echo "3. APK + App Bundle + IPA (All)"
  echo "═══════════════════════════════════════"
  read -p "Enter your choice [1-3]: " build_choice
  clean_flutter
  clean_android
  clean_ios
  case $build_choice in
  1)
   # APK + IPA only
   build_android
   build_ios
   ;;
  2)
   # App Bundle + IPA only
   build_appbundle
   build_ios
   ;;
  3)
   # APK + App Bundle + IPA (All)
   build_android
   build_appbundle
   build_ios
   ;;
  *)
   echo ":x: Invalid choice! Please choose 1, 2, or 3."
   continue
   ;;
  esac
  ;;
 15)
  choose_project || continue
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  clean_ios
  build_ios
  upload_ios_ipa_to_drive
  clean_flutter
  ;;
 16)
  choose_project || continue
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  clean_ios
  build_multiple_ios_ipas
  upload_multiple_ios_ipas_to_drive
  clean_flutter
  ;;
 17)
  choose_project || continue
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  echo ""
  echo "═══════════════════════════════════════"
  echo "      SELECT BUILD MODE"
  echo "═══════════════════════════════════════"
  echo "1. Single flavor (or no flavor)"
  echo "2. Multiple flavors"
  echo "═══════════════════════════════════════"
  read -p "Enter your choice [1-2]: " mode_choice
  case $mode_choice in
  1)
   # Single flavor workflow
   prompt_flavor
   clean_flutter
   clean_android
   clean_ios
   build_android
   build_ios
   upload_apk_to_drive
   upload_ios_ipa_to_drive
   clean_flutter
   ;;
  2)
   # Multiple flavors workflow
   prompt_multiple_flavors || continue
   clean_flutter
   clean_android
   clean_ios
   build_multiple_android_apks
   build_multiple_ios_ipas
   upload_multiple_apks_to_drive
   upload_multiple_ios_ipas_to_drive
   clean_flutter
   ;;
  *)
   echo ":x: Invalid mode choice! Please choose 1 or 2."
   continue
   ;;
  esac
  ;;
 18)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  echo ""
  echo "═══════════════════════════════════════"
  echo "      SELECT BUILD COMBINATION"
  echo "═══════════════════════════════════════"
  echo "1. APK + IPA"
  echo "2. App Bundle + IPA"
  echo "3. APK + App Bundle + IPA (All)"
  echo "═══════════════════════════════════════"
  read -p "Enter your choice [1-3]: " build_choice
  clean_flutter
  clean_android
  clean_ios
  case $build_choice in
  1)
   # APK + IPA only
   build_multiple_android_apks
   build_multiple_ios_ipas
   ;;
  2)
   # App Bundle + IPA only
   build_multiple_appbundles
   build_multiple_ios_ipas
   ;;
  3)
   # APK + App Bundle + IPA (All)
   build_multiple_android_apks
   build_multiple_appbundles
   build_multiple_ios_ipas
   ;;
  *)
   echo ":x: Invalid choice! Please choose 1, 2, or 3."
   continue
   ;;
  esac
  ;;
 19)
  echo ":wave: Exiting..."
  break
  ;;
 *)
  echo ":x: Invalid option! Please choose a valid option."
  ;;
 esac
done
