#!/bin/bash
set -e
# --- File to store flavor history ---
FLAVOR_LIST_FILE="$HOME/.flutter_flavor_list"
FLAVOR_FILE="$HOME/.flutter_build_flavor"

# --- Function: Validate Flutter project ---
validate_flutter_project() {
 if [ ! -f "pubspec.yaml" ]; then
  echo ":x: Error: Not a Flutter project! (pubspec.yaml not found)"
  echo "Please run this script from a Flutter project directory."
  exit 1
 fi
}

# --- Function: Validate Flutter/FVM installation ---
validate_flutter_installation() {
 local cmd="$1"
 if ! command -v $cmd &> /dev/null; then
  echo ":x: Error: $cmd is not installed or not in PATH!"
  if [ "$cmd" = "fvm" ]; then
   echo "Please install FVM: https://fvm.app/docs/getting_started/installation"
  else
   echo "Please install Flutter: https://flutter.dev/docs/get-started/install"
  fi
  exit 1
 fi
}

# --- Function: Get project root folder name ---
get_project_name() {
 basename "$(pwd)"
}

# --- Function: Validate flavor exists in project ---
validate_flavor() {
 local flavor="$1"
 
 if [ -z "$flavor" ]; then
  return 0  # No flavor is valid
 fi
 
 # Check flavorizr.yaml (primary source for flavorizr package)
 if [ -f "flavorizr.yaml" ]; then
  # Check if flavor exists in flavorizr.yaml
  # flavorizr.yaml typically has flavors defined under a 'flavors' key
  if grep -q "$flavor" flavorizr.yaml 2>/dev/null; then
   # More specific check: look for the flavor name as a key or in flavor definitions
   if grep -E "^[[:space:]]*$flavor[[:space:]]*:" flavorizr.yaml 2>/dev/null || \
      grep -E "[[:space:]]*$flavor[[:space:]]*:" flavorizr.yaml 2>/dev/null; then
    return 0  # Flavor found in flavorizr.yaml
   fi
   # Also check if it's in a list format
   if grep -E "['\"]$flavor['\"]" flavorizr.yaml 2>/dev/null; then
    return 0
   fi
  fi
 fi
 
 # Check pubspec.yaml for flavorizr configuration
 if [ -f "pubspec.yaml" ]; then
  # Check if flavorizr is configured and flavor is mentioned
  if grep -q "flavorizr" pubspec.yaml 2>/dev/null; then
   # Check if flavor name appears in pubspec.yaml (might be in flavorizr config)
   if grep -q "$flavor" pubspec.yaml 2>/dev/null; then
    return 0  # Flavor found in pubspec.yaml
   fi
  fi
 fi
 
 # Check android/app/flavorizr.gradle (Android flavorizr generated file)
 if [ -f "android/app/flavorizr.gradle" ]; then
  if grep -q "$flavor" android/app/flavorizr.gradle 2>/dev/null; then
   return 0  # Flavor found in flavorizr.gradle
  fi
 fi
 
 # Fallback: Check Android flavors in build.gradle (for non-flavorizr projects)
 if [ -f "android/app/build.gradle" ]; then
  # Look for productFlavors block and check if flavor name appears within it
  if grep -q "productFlavors" android/app/build.gradle; then
   # Extract the productFlavors section and check if flavor name appears within it
   if awk '/productFlavors\s*\{/,/^[[:space:]]*\}/ { if (index($0, "'"$flavor"'")) found=1 } END { exit !found }' android/app/build.gradle 2>/dev/null; then
    return 0  # Flavor found in Android productFlavors
   fi
  fi
 fi
 
 # Check iOS - look for flavor in Xcode project files or Info.plist
 # iOS flavor validation is more complex, so we'll check common locations
 if [ -d "ios" ]; then
  # Check if flavor appears in any iOS configuration files
  # This is a lenient check - if Android doesn't exist, we assume iOS might have it
  if [ ! -d "android" ]; then
   # iOS-only project - be lenient and assume flavor might be valid
   return 0
  fi
 fi
 
 # If we reach here and Android exists but flavor not found, it's invalid
 if [ -d "android" ]; then
  return 1  # Flavor not found in Android project
 fi
 
 # Default: assume valid if we can't determine (for edge cases)
 return 0
}

# --- Function: Send cross-platform notification ---
send_notification() {
 local title="$1"
 local message="$2"
 local sound="${3:-true}"
 local project_name=$(get_project_name)
 
 # Add project name to title
 local full_title="$title - $project_name"
 
 # Detect OS
 if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOS - use osascript
  if [ "$sound" = "true" ]; then
   osascript -e "display notification \"$message\" with title \"$full_title\" sound name \"Glass\""
  else
   osascript -e "display notification \"$message\" with title \"$full_title\""
  fi
 elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
  # Linux - use notify-send
  if command -v notify-send &> /dev/null; then
   if [ "$sound" = "true" ]; then
    notify-send -u normal -i "dialog-information" "$full_title" "$message"
   else
    notify-send -u normal -i "dialog-information" "$full_title" "$message"
   fi
  fi
 fi
}

# --- Function to ensure flavor list file exists ---
ensure_flavor_list() {
 if [ ! -f "$FLAVOR_LIST_FILE" ]; then
  echo "[]" > "$FLAVOR_LIST_FILE"
 fi
}

# --- Function to add flavor to list ---
add_flavor_to_list() {
 local new_flavor="$1"
 ensure_flavor_list
 # Check if flavor already exists
 if jq -e --arg flavor "$new_flavor" 'index($flavor) != null' "$FLAVOR_LIST_FILE" > /dev/null 2>&1; then
  return 0
 fi
 # Add flavor to list
 jq --arg flavor "$new_flavor" '. + [$flavor]' "$FLAVOR_LIST_FILE" > "$FLAVOR_LIST_FILE.tmp" && mv "$FLAVOR_LIST_FILE.tmp" "$FLAVOR_LIST_FILE"
 echo ":white_check_mark: Flavor '$new_flavor' added to history!"
}

# --- Function to check FVM choice ---
select_fvm() {
 echo "Would you like to use FVM (Flutter Version Manager)?"
 echo "1. Yes, use FVM"
 echo "2. No, use the default Flutter"
 read -p "Enter your choice [1-2]: " fvm_choice
 case $fvm_choice in
 1)
  FLUTTER_CMD="fvm flutter"
  validate_flutter_installation "fvm"
  echo "Using FVM for Flutter commands."
  ;;
 2)
  FLUTTER_CMD="flutter"
  validate_flutter_installation "flutter"
  echo "Using default Flutter command."
  ;;
 *)
  echo ":x: Invalid option! Defaulting to using the default Flutter command."
  FLUTTER_CMD="flutter"
  validate_flutter_installation "flutter"
  ;;
 esac
}

# --- Function to prompt for flavor with history ---
prompt_flavor() {
 ensure_flavor_list
 echo ""
 echo "═══════════════════════════════════════"
 echo "        SELECT BUILD FLAVOR"
 echo "═══════════════════════════════════════"
 # Read saved flavors
 local flavors=($(jq -r '.[]' "$FLAVOR_LIST_FILE" 2>/dev/null || echo ""))
 if [ "${#flavors[@]}" -gt 0 ]; then
  echo ":clipboard: Saved flavors:"
  i=1
  for flavor in "${flavors[@]}"; do
   # Mark last used flavor
   if [ -f "$FLAVOR_FILE" ] && [ "$flavor" = "$(cat "$FLAVOR_FILE")" ]; then
    echo "  $i) $flavor :star: (last used)"
   else
    echo "  $i) $flavor"
   fi
   ((i++))
  done
  echo "  0) No flavor (skip)"
  echo "  +) Add new flavor"
  echo ""
  read -p "Enter your choice [0-${#flavors[@]} or +]: " choice
  if [ "$choice" = "+" ]; then
   read -p "Enter new flavor name: " new_flavor_name
   if [ -n "$new_flavor_name" ]; then
    add_flavor_to_list "$new_flavor_name"
    FLAVOR_NAME="$new_flavor_name"
    FLAVOR_FLAGS="--flavor $FLAVOR_NAME --dart-define=FLAVOR=$FLAVOR_NAME"
    echo "$FLAVOR_NAME" > "$FLAVOR_FILE"
    echo ":white_check_mark: Building with flavor: $FLAVOR_NAME"
   else
    echo ":x: Flavor name cannot be empty!"
    prompt_flavor
    return
   fi
  elif [ "$choice" = "0" ]; then
   FLAVOR_FLAGS=""
   FLAVOR_NAME=""
   echo ":white_check_mark: Building without flavor"
  elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#flavors[@]}" ]; then
   FLAVOR_NAME="${flavors[$((choice-1))]}"
   FLAVOR_FLAGS="--flavor $FLAVOR_NAME --dart-define=FLAVOR=$FLAVOR_NAME"
   echo "$FLAVOR_NAME" > "$FLAVOR_FILE"
   echo ":white_check_mark: Building with flavor: $FLAVOR_NAME"
  else
   echo ":x: Invalid choice!"
   prompt_flavor
   return
  fi
 else
  echo ":information_source:  No saved flavors found."
  echo ""
  read -p "Enter flavor name (press Enter to skip): " FLAVOR_NAME
  if [ -z "$FLAVOR_NAME" ]; then
   FLAVOR_FLAGS=""
   echo ":white_check_mark: Building without flavor"
  else
   add_flavor_to_list "$FLAVOR_NAME"
   FLAVOR_FLAGS="--flavor $FLAVOR_NAME --dart-define=FLAVOR=$FLAVOR_NAME"
   echo "$FLAVOR_NAME" > "$FLAVOR_FILE"
   echo ":white_check_mark: Building with flavor: $FLAVOR_NAME"
  fi
 fi
 echo "═══════════════════════════════════════"
 echo ""
 
 # Validate selected flavor exists in current project
 if [ -n "$FLAVOR_NAME" ]; then
  if ! validate_flavor "$FLAVOR_NAME"; then
   echo ":x: Error: Flavor '$FLAVOR_NAME' does not exist in the current project!"
   echo "Please check your Android build.gradle or iOS configuration."
   exit 1
  fi
 fi
}

# --- Function to select multiple flavors ---
prompt_multiple_flavors() {
 ensure_flavor_list
 echo ""
 echo "═══════════════════════════════════════"
 echo "    SELECT MULTIPLE BUILD FLAVORS"
 echo "═══════════════════════════════════════"
 # Read saved flavors
 local flavors=($(jq -r '.[]' "$FLAVOR_LIST_FILE" 2>/dev/null || echo ""))
 if [ "${#flavors[@]}" -eq 0 ]; then
  echo ":x: No saved flavors found. Please add flavors first."
  return 1
 fi
 
 echo ":clipboard: Available flavors:"
 i=1
 for flavor in "${flavors[@]}"; do
  echo "  $i) $flavor"
  ((i++))
 done
 echo ""
 echo "Enter flavor numbers separated by spaces (e.g., 1 3 5)"
 echo "Or enter 'all' to build all flavors"
 echo "Or enter '+' to add a new flavor"
 read -p "Your selection: " selection
 
 SELECTED_FLAVORS=()
 
 if [ "$selection" = "all" ]; then
  SELECTED_FLAVORS=("${flavors[@]}")
  echo ":white_check_mark: Selected all flavors: ${SELECTED_FLAVORS[*]}"
 elif [ "$selection" = "+" ]; then
  read -p "Enter new flavor name: " new_flavor_name
  if [ -z "$new_flavor_name" ]; then
   echo ":x: Flavor name cannot be empty!"
   # Show list again
   prompt_multiple_flavors
   return
  fi
  add_flavor_to_list "$new_flavor_name"
  echo ":white_check_mark: Flavor '$new_flavor_name' added to history!"
  echo ""
  # Show the list again so user can select flavors
  prompt_multiple_flavors
  return
 else
  for num in $selection; do
   if [[ "$num" =~ ^[0-9]+$ ]] && [ "$num" -ge 1 ] && [ "$num" -le "${#flavors[@]}" ]; then
    SELECTED_FLAVORS+=("${flavors[$((num-1))]}")
   else
    echo ":warning: Skipping invalid selection: $num"
   fi
  done
  
  if [ "${#SELECTED_FLAVORS[@]}" -eq 0 ]; then
   echo ":x: No valid flavors selected!"
   return 1
  fi
  
  echo ":white_check_mark: Selected flavors: ${SELECTED_FLAVORS[*]}"
 fi
 
 # Validate and filter flavors that exist in current project
 local original_count=${#SELECTED_FLAVORS[@]}
 VALID_FLAVORS=()
 for flavor in "${SELECTED_FLAVORS[@]}"; do
  if validate_flavor "$flavor"; then
   VALID_FLAVORS+=("$flavor")
  else
   echo ":warning: Flavor '$flavor' does not exist in current project. Removing from selection."
  fi
 done
 
 # Update SELECTED_FLAVORS with only valid flavors
 SELECTED_FLAVORS=("${VALID_FLAVORS[@]}")
 
 # Check if any valid flavors remain
 if [ "${#SELECTED_FLAVORS[@]}" -eq 0 ]; then
  echo ":x: Error: No valid flavors found in the current project!"
  echo "All selected flavors were removed. Please check your project configuration."
  return 1
 fi
 
 # Show message if some flavors were filtered out
 if [ "${#SELECTED_FLAVORS[@]}" -lt "$original_count" ]; then
  echo ":white_check_mark: Valid flavors after filtering: ${SELECTED_FLAVORS[*]}"
 fi
 
 echo "═══════════════════════════════════════"
 echo ""
}

# --- Function: Clean Flutter general (shared) ---
clean_flutter() {
 echo ":arrows_counterclockwise: Cleaning Flutter project..."
 if ! $FLUTTER_CMD clean; then
  echo ":warning: Flutter clean had issues, but continuing..."
 fi
 if ! $FLUTTER_CMD pub get; then
  echo ":x: Failed to get dependencies!"
  return 1
 fi
}

# --- Function: Clean Android specific files ---
clean_android() {
 if [ ! -d "android" ]; then
  echo ":warning: Android directory not found. Skipping Android clean."
  return 0
 fi
 echo ":broom: Cleaning Android project..."
 cd android
 if [ -f "gradlew" ]; then
  ./gradlew clean
 else
  echo ":warning: gradlew not found. Skipping gradle clean."
 fi
 cd -
}

# --- Function: Clean iOS specific files ---
clean_ios() {
 if [ ! -d "ios" ]; then
  echo ":warning: iOS directory not found. Skipping iOS clean."
  return 0
 fi
 echo ":broom: Cleaning iOS pods..."
 cd ios
 if [ -f "Podfile" ]; then
  rm -rf Pods/ Podfile.lock
  pod install
 else
  echo ":warning: Podfile not found. Skipping pod operations."
 fi
 cd -
}

# --- Function: Build Android APK ---
build_android() {
 echo ":package: Building Android APK..."
 if $FLUTTER_CMD build apk $FLAVOR_FLAGS; then
  echo ":white_check_mark: APK build completed!"
  local flavor_msg=""
  if [ -n "$FLAVOR_NAME" ]; then
   flavor_msg=" (Flavor: $FLAVOR_NAME)"
  fi
  send_notification "Flutter Build" "Android APK build completed successfully!$flavor_msg"
 else
  send_notification "Flutter Build" "Android APK build failed!" "false"
  return 1
 fi
}

# --- Function: Build multiple Android APKs ---
build_multiple_android_apks() {
 echo ""
 echo ":rocket: Building multiple Android APKs..."
 echo ""
 
 local success_count=0
 local total_count=${#SELECTED_FLAVORS[@]}
 BUILT_APKS=()
 
 for flavor in "${SELECTED_FLAVORS[@]}"; do
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":package: Building flavor: $flavor ($((success_count + 1))/$total_count)"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  if $FLUTTER_CMD build apk --flavor "$flavor" --dart-define=FLAVOR="$flavor"; then
   # Use default Flutter build output path
   source_apk="build/app/outputs/flutter-apk/app-${flavor}-release.apk"
   if [ -f "$source_apk" ]; then
    BUILT_APKS+=("$source_apk:$flavor")
    echo ":white_check_mark: APK for $flavor built successfully"
    ((success_count++))
   else
    echo ":warning: APK not found for $flavor at $source_apk"
   fi
  else
   echo ":x: Failed to build $flavor"
  fi
  echo ""
 done
 
 echo "═══════════════════════════════════════"
 echo ":tada: Multi-flavor build completed!"
 echo "Success: $success_count/$total_count"
 echo "═══════════════════════════════════════"
 
 # Send notification
 if [ "$success_count" -eq "$total_count" ]; then
  send_notification "Flutter Build" "All $total_count Android APK builds completed successfully!"
 elif [ "$success_count" -gt 0 ]; then
  send_notification "Flutter Build" "Multi-flavor build: $success_count/$total_count APKs built successfully" "false"
 else
  send_notification "Flutter Build" "Multi-flavor build failed!" "false"
 fi
}

# ============================================
# COMMON UPLOAD UTILITIES (SOLID Principles)
# ============================================

# --- Function: Ensure gdrive is installed ---
ensure_gdrive_installed() {
 if ! command -v gdrive &> /dev/null; then
  echo ":arrow_down_small: Installing gdrive..."
  curl -L -o gdrive.tar.gz https://github.com/glotlabs/gdrive/releases/download/3.9.1/gdrive_linux-x64.tar.gz
  tar -xzf gdrive.tar.gz
  chmod +x gdrive
  sudo mv gdrive /usr/local/bin/
  echo ":white_check_mark: gdrive installed successfully!"
 fi
}

# --- Function: Ensure gdrive is authenticated ---
ensure_gdrive_authenticated() {
 if [ -z "$GDRIVE_ACCOUNT_FILE" ]; then
  echo ":x: GDRIVE_ACCOUNT_FILE environment variable is not set!"
  echo "Please add 'export GDRIVE_ACCOUNT_FILE=your_file_path' to your ~/.zshrc"
  return 1
 fi
 
 if ! gdrive about &>/dev/null; then
  echo ":key: Importing gdrive account..."
  gdrive account import "$GDRIVE_ACCOUNT_FILE"
 else
  echo ":white_check_mark: gdrive account already imported."
 fi
}
 
# --- Function: Get app version from pubspec.yaml ---
get_app_version() {
 if [ -f "pubspec.yaml" ]; then
  local version=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
  if [ -n "$version" ]; then
   echo "$version"
  fi
 fi
}

# --- Function: Build filename for upload ---
build_upload_filename() {
 local file_type="$1"        # apk, aab, ipa
 local flavor_name="$2"      # optional
 local app_version="$3"      # optional
 local custom_name="$4"      # optional
 local date_str=$(date +%d-%m-%Y)
 
 local filename="${APP_NAME}"
 [ -n "$custom_name" ] && filename="${filename} ${custom_name}"
 [ -n "$flavor_name" ] && filename="${filename} ${flavor_name}"
  
  if [ -n "$app_version" ]; then
  filename="${filename} v${app_version} (${date_str})"
  else
  filename="${filename} (${date_str})"
 fi
 
 echo "${filename}.${file_type}"
}

# --- Function: Copy text to clipboard (cross-platform) ---
copy_to_clipboard() {
 local text="$1"
 
 # Extract URLs from the text (matches http:// and https:// URLs)
 local urls=$(echo "$text" | grep -oE 'https?://[^[:space:]]+' | sort -u)
 
 # If URLs were found, use them; otherwise use original text
 if [ -n "$urls" ]; then
  local text_to_copy="$urls"
 else
  local text_to_copy="$text"
 fi
 
 if command -v pbcopy &>/dev/null; then
  echo "$text_to_copy" | pbcopy
  echo ":clipboard: Link copied to clipboard!"
 elif command -v xclip &>/dev/null; then
  echo "$text_to_copy" | xclip -selection clipboard
  echo ":clipboard: Link copied to clipboard!"
 elif command -v xsel &>/dev/null; then
  echo "$text_to_copy" | xsel --clipboard --input
  echo ":clipboard: Link copied to clipboard!"
 else
  echo ":warning: Clipboard tool not found. Install pbcopy/xclip/xsel to auto-copy."
  return 1
 fi
}

# --- Function: Display upload success message ---
display_upload_success() {
 local platform_name="$1"      # Android APK, iOS IPA, App Bundle
 local flavor_name="$2"         # optional
 local custom_name="$3"         # optional
 local file_url="$4"
 
 local label_parts="Uploaded for $platform_name"
 [ -n "$flavor_name" ] && label_parts="${label_parts} $flavor_name"
 [ -n "$custom_name" ] && label_parts="${label_parts} $custom_name"
 label_parts="${label_parts} success"
 
 echo ""
 echo ":white_check_mark: $label_parts"
 echo "$file_url"
 echo ""
}

# --- Function: Upload single file to Google Drive and return URL ---
upload_single_file_to_drive() {
 local source_path="$1"
 local target_filename="$2"
 local folder_id="$3"
 local flavor_name="$4"      # optional, for display
 
 if [ ! -f "$source_path" ]; then
  echo ":x: File not found at $source_path" >&2
  return 1
 fi
 
 # Copy to temp location with new filename
 local temp_file="${source_path%/*}/${target_filename}"
 cp "$source_path" "$temp_file"
  
 echo "Uploading: $(basename "$temp_file")"
 local upload_output=$(gdrive files upload --parent "$folder_id" "$temp_file" 2>&1)
 local upload_exit_code=$?
  
  if [ $upload_exit_code -ne 0 ]; then
  echo ":x: Upload failed (exit code: $upload_exit_code)" >&2
  rm -f "$temp_file"
  return 1
  fi
  
 # Extract file ID from upload output
 local file_id=$(echo "$upload_output" | grep 'Id:' | awk '{print $2}')
  
  if [ -z "$file_id" ]; then
  echo ":x: Failed to retrieve file ID from upload output." >&2
  rm -f "$temp_file"
  return 1
  fi
  
 # Share file
  gdrive permissions share "$file_id" > /dev/null 2>&1
 local file_url="https://drive.google.com/file/d/$file_id/view"
  
 # Cleanup temp file
 rm -f "$temp_file"
 
 # Return URL via echo (caller should capture with $())
 echo "$file_url"
 return 0
}

# ============================================
# UPLOAD FUNCTIONS (Using Common Utilities)
# ============================================

# --- Function: Upload multiple APKs to Google Drive ---
upload_multiple_apks_to_drive() {
 echo ":lightning: Preparing to upload multiple APKs to Google Drive..."
 
 # Setup gdrive
 ensure_gdrive_installed || return 1
 ensure_gdrive_authenticated || return 1
 
 # Get app version
 local app_version=$(get_app_version)
 if [ -n "$app_version" ]; then
  echo ":label: App version: $app_version"
 fi
 
 local upload_count=0
 UPLOAD_LINKS=()
 
 for apk_info in "${BUILT_APKS[@]}"; do
  local apk_path="${apk_info%%:*}"
  local flavor_name="${apk_info##*:}"
  
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":arrow_up_small: Uploading flavor: $flavor_name"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  # Build filename
  local filename=$(build_upload_filename "apk" "$flavor_name" "$app_version" "$CUSTOM_NAME")
  
  echo "Uploading: $(basename "$filename")"
  
  # Upload file
  local file_url=$(upload_single_file_to_drive "$apk_path" "$filename" "$GDRIVE_FOLDER_ID" "$flavor_name")
  
  if [ $? -eq 0 ] && [ -n "$file_url" ]; then
   # Display success message
   display_upload_success "Android APK" "$flavor_name" "$CUSTOM_NAME" "$file_url"
   UPLOAD_LINKS+=("$flavor_name: $file_url")
  ((upload_count++))
  fi
 done
 
 echo ""
 echo "═══════════════════════════════════════"
 echo ":tada: Upload completed!"
 echo "Uploaded: $upload_count/${#BUILT_APKS[@]}"
 echo "═══════════════════════════════════════"
 echo ""
 echo ":link: Download Links:"
 for link in "${UPLOAD_LINKS[@]}"; do
  echo "  • $link"
 done
 echo ""
 
 # Copy all links to clipboard
 local all_links=$(printf "%s\n" "${UPLOAD_LINKS[@]}")
 copy_to_clipboard "$all_links"
 
 # Send notification
 if [ "$upload_count" -eq "${#BUILT_APKS[@]}" ]; then
  send_notification "Google Drive Upload" "All $upload_count APKs uploaded successfully!"
 elif [ "$upload_count" -gt 0 ]; then
  send_notification "Google Drive Upload" "Uploaded $upload_count/${#BUILT_APKS[@]} APKs" "false"
 else
  send_notification "Google Drive Upload" "Upload failed!" "false"
 fi
}

# --- Function: Build multiple Android App Bundles ---
build_multiple_appbundles() {
 echo ""
 echo ":rocket: Building multiple Android App Bundles..."
 echo ""
 
 local success_count=0
 local total_count=${#SELECTED_FLAVORS[@]}
 BUILT_APPBUNDLES=()
 
 for flavor in "${SELECTED_FLAVORS[@]}"; do
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":package: Building App Bundle for flavor: $flavor ($((success_count + 1))/$total_count)"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  if $FLUTTER_CMD build appbundle --flavor "$flavor" --dart-define=FLAVOR="$flavor"; then
   # Use default Flutter build output path
   source_aab="build/app/outputs/bundle/${flavor}Release/app-${flavor}-release.aab"
   if [ -f "$source_aab" ]; then
    BUILT_APPBUNDLES+=("$source_aab:$flavor")
    echo ":white_check_mark: App Bundle for $flavor built successfully"
    ((success_count++))
   else
    echo ":warning: App Bundle not found for $flavor at $source_aab"
   fi
  else
   echo ":x: Failed to build App Bundle for $flavor"
  fi
  echo ""
 done
 
 echo "═══════════════════════════════════════"
 echo ":tada: Multi-flavor App Bundle build completed!"
 echo "Success: $success_count/$total_count"
 echo "═══════════════════════════════════════"
 
 # Send notification
 if [ "$success_count" -eq "$total_count" ]; then
  send_notification "Flutter Build" "All $total_count Android App Bundle builds completed successfully!"
 elif [ "$success_count" -gt 0 ]; then
  send_notification "Flutter Build" "Multi-flavor build: $success_count/$total_count App Bundles built successfully" "false"
 else
  send_notification "Flutter Build" "Multi-flavor App Bundle build failed!" "false"
 fi
}

# --- Function: Upload multiple App Bundles to Google Drive ---
upload_multiple_appbundles_to_drive() {
 echo ":lightning: Preparing to upload multiple App Bundles to Google Drive..."
 
 # Setup gdrive
 ensure_gdrive_installed || return 1
 ensure_gdrive_authenticated || return 1
 
 # Get app version
 local app_version=$(get_app_version)
 if [ -n "$app_version" ]; then
  echo ":label: App version: $app_version"
 fi
 
 local upload_count=0
 UPLOAD_LINKS=()
 
 for aab_info in "${BUILT_APPBUNDLES[@]}"; do
  local aab_path="${aab_info%%:*}"
  local flavor_name="${aab_info##*:}"
  
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":arrow_up_small: Uploading flavor: $flavor_name"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  # Build filename
  local filename=$(build_upload_filename "aab" "$flavor_name" "$app_version" "$CUSTOM_NAME")
  
  echo "Uploading: $(basename "$filename")"
  
  # Upload file
  local file_url=$(upload_single_file_to_drive "$aab_path" "$filename" "$GDRIVE_FOLDER_ID" "$flavor_name")
  
  if [ $? -eq 0 ] && [ -n "$file_url" ]; then
   # Display success message
   display_upload_success "App Bundle" "$flavor_name" "$CUSTOM_NAME" "$file_url"
   UPLOAD_LINKS+=("$flavor_name: $file_url")
   ((upload_count++))
  fi
 done
 
 echo ""
 echo "═══════════════════════════════════════"
 echo ":tada: Upload completed!"
 echo "Uploaded: $upload_count/${#BUILT_APPBUNDLES[@]}"
 echo "═══════════════════════════════════════"
 echo ""
 echo ":link: Download Links:"
 for link in "${UPLOAD_LINKS[@]}"; do
  echo "  • $link"
 done
 echo ""
 
 # Copy all links to clipboard
 local all_links=$(printf "%s\n" "${UPLOAD_LINKS[@]}")
 copy_to_clipboard "$all_links"
 
 # Send notification
 if [ "$upload_count" -eq "${#BUILT_APPBUNDLES[@]}" ]; then
  send_notification "Google Drive Upload" "All $upload_count App Bundles uploaded successfully!"
 elif [ "$upload_count" -gt 0 ]; then
  send_notification "Google Drive Upload" "Uploaded $upload_count/${#BUILT_APPBUNDLES[@]} App Bundles" "false"
 else
  send_notification "Google Drive Upload" "Upload failed!" "false"
 fi
}

# --- Function: Build multiple iOS IPAs ---
build_multiple_ios_ipas() {
 echo ""
 echo ":rocket: Building multiple iOS IPAs..."
 echo ""
 
 local success_count=0
 local total_count=${#SELECTED_FLAVORS[@]}
 BUILT_IPAS=()
 
 for flavor in "${SELECTED_FLAVORS[@]}"; do
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":package: Building flavor: $flavor ($((success_count + 1))/$total_count)"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  if $FLUTTER_CMD build ipa --flavor "$flavor" --dart-define=FLAVOR="$flavor"; then
   # Find the IPA (iOS uses a different structure)
   source_ipa=$(find build/ios/ipa -name "*.ipa" -type f | head -n 1)
   if [ -n "$source_ipa" ]; then
    BUILT_IPAS+=("$source_ipa:$flavor")
    echo ":white_check_mark: IPA for $flavor built successfully"
    ((success_count++))
   else
    echo ":warning: IPA not found for $flavor"
   fi
  else
   echo ":x: Failed to build $flavor"
  fi
  echo ""
 done
 
 echo "═══════════════════════════════════════"
 echo ":tada: Multi-flavor build completed!"
 echo "Success: $success_count/$total_count"
 echo "═══════════════════════════════════════"
 
 # Send notification
 if [ "$success_count" -eq "$total_count" ]; then
  send_notification "Flutter Build" "All $total_count iOS IPA builds completed successfully!"
 elif [ "$success_count" -gt 0 ]; then
  send_notification "Flutter Build" "Multi-flavor build: $success_count/$total_count IPAs built successfully" "false"
 else
  send_notification "Flutter Build" "Multi-flavor iOS IPA build failed!" "false"
 fi
}

PROJECTS_FILE="$HOME/.apk_uploader_projects.json"
PROJECTS_FILE_IPA="$HOME/.ipa_uploader_projects.json"

ensure_projects_file() {
 if [ ! -f "$PROJECTS_FILE" ]; then
  echo "{}" > "$PROJECTS_FILE"
 fi
}

ensure_projects_file_ipa() {
 if [ ! -f "$PROJECTS_FILE_IPA" ]; then
  echo "{}" > "$PROJECTS_FILE_IPA"
 fi
}

choose_project() {
 ensure_projects_file
 local ids=($(jq -r 'keys[]' "$PROJECTS_FILE"))
 if [ "${#ids[@]}" -eq 0 ]; then
  echo ":memo: No saved projects found. Let's add one."
  add_new_project
  return
 fi
 echo ":rocket: Choose your app to upload:"
 i=1
 for folder_id in "${ids[@]}"; do
  app_name=$(jq -r --arg id "$folder_id" '.[$id]' "$PROJECTS_FILE")
  echo "$i) $app_name [$folder_id]"
  ((i++))
 done
 echo ":heavy_plus_sign: Add a new project"
 read -p "Enter your choice [1-${#ids[@]} or +]: " choice
 if [ "$choice" = "+" ]; then
  add_new_project
 elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#ids[@]}" ]; then
  GDRIVE_FOLDER_ID="${ids[$((choice-1))]}"
  APP_NAME=$(jq -r --arg id "$GDRIVE_FOLDER_ID" '.[$id]' "$PROJECTS_FILE")
 else
  echo ":x: Invalid choice."
  return 1
 fi
}

choose_project_ipa() {
 ensure_projects_file_ipa
 local ids=($(jq -r 'keys[]' "$PROJECTS_FILE_IPA"))
 if [ "${#ids[@]}" -eq 0 ]; then
  echo ":memo: No saved projects found. Let's add one."
  add_new_project_ipa
  return
 fi
 echo ":rocket: Choose your app to upload:"
 i=1
 for folder_id in "${ids[@]}"; do
  app_name=$(jq -r --arg id "$folder_id" '.[$id]' "$PROJECTS_FILE_IPA")
  echo "$i) $app_name [$folder_id]"
  ((i++))
 done
 echo ":heavy_plus_sign: Add a new project"
 read -p "Enter your choice [1-${#ids[@]} or +]: " choice
 if [ "$choice" = "+" ]; then
  add_new_project_ipa
 elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#ids[@]}" ]; then
  GDRIVE_FOLDER_ID_IPA="${ids[$((choice-1))]}"
  APP_NAME_IPA=$(jq -r --arg id "$GDRIVE_FOLDER_ID_IPA" '.[$id]' "$PROJECTS_FILE_IPA")
 else
  echo ":x: Invalid choice."
  return 1
 fi
}

add_new_project() {
 read -p "Enter Google Drive Folder ID: " new_folder_id
 read -p "Enter App Name: " new_app_name
 # Check if folder ID already exists
 if jq -e --arg id "$new_folder_id" 'has($id)' "$PROJECTS_FILE" > /dev/null; then
  echo ":warning:  This folder ID is already saved."
  return 1
 fi
 jq --arg id "$new_folder_id" --arg name "$new_app_name" '. + {($id): $name}' "$PROJECTS_FILE" > "$PROJECTS_FILE.tmp" && mv "$PROJECTS_FILE.tmp" "$PROJECTS_FILE"
 GDRIVE_FOLDER_ID="$new_folder_id"
 APP_NAME="$new_app_name"
 echo ":white_check_mark: Project saved!"
}

add_new_project_ipa() {
 read -p "Enter Google Drive Folder ID: " new_folder_id
 read -p "Enter App Name: " new_app_name
 # Check if folder ID already exists
 if jq -e --arg id "$new_folder_id" 'has($id)' "$PROJECTS_FILE_IPA" > /dev/null; then
  echo ":warning:  This folder ID is already saved."
  return 1
 fi
 jq --arg id "$new_folder_id" --arg name "$new_app_name" '. + {($id): $name}' "$PROJECTS_FILE_IPA" > "$PROJECTS_FILE_IPA.tmp" && mv "$PROJECTS_FILE_IPA.tmp" "$PROJECTS_FILE_IPA"
 GDRIVE_FOLDER_ID_IPA="$new_folder_id"
 APP_NAME_IPA="$new_app_name"
 echo ":white_check_mark: Project saved!"
}

# --- Function: Upload APK to Google Drive ---
upload_apk_to_drive() {
 echo ":lightning:  Preparing to upload APK to Google Drive..."
 
 # Setup gdrive
 ensure_gdrive_installed || return 1
 ensure_gdrive_authenticated || return 1
 
 # Get app version
 local app_version=$(get_app_version)
  if [ -n "$app_version" ]; then
   echo ":label: App version: $app_version"
 fi
 
 # Determine APK path based on flavor
 local apk_path
 if [ -z "$FLAVOR_NAME" ]; then
  apk_path="build/app/outputs/flutter-apk/app-release.apk"
 else
  apk_path="build/app/outputs/flutter-apk/app-${FLAVOR_NAME}-release.apk"
 fi
 
 if [ ! -f "$apk_path" ]; then
  echo ":x: APK not found at $apk_path"
  return 1
 fi
 
 # Build filename
 local filename=$(build_upload_filename "apk" "$FLAVOR_NAME" "$app_version" "$CUSTOM_NAME")
 
 echo "Uploading: $(basename "$filename")"
 
 # Upload file
 local file_url=$(upload_single_file_to_drive "$apk_path" "$filename" "$GDRIVE_FOLDER_ID" "$FLAVOR_NAME")
 
 if [ $? -ne 0 ] || [ -z "$file_url" ]; then
  send_notification "Google Drive Upload" "APK upload failed!" "false"
  return 1
 fi
 
 # Display success message
 display_upload_success "Android APK" "$FLAVOR_NAME" "$CUSTOM_NAME" "$file_url"
 
 # Copy link to clipboard
 copy_to_clipboard "$file_url"

 # Delete local APK file after successful upload
 echo ":wastebasket:  Deleting local APK file..."
 if rm -f "$apk_path"; then
  echo ":white_check_mark: Local APK file deleted successfully!"
 else
  echo ":warning:  Failed to delete local APK file."
 fi
 
 # Send notification
 local flavor_msg=""
 [ -n "$FLAVOR_NAME" ] && flavor_msg=" (Flavor: $FLAVOR_NAME)"
 send_notification "Google Drive Upload" "APK uploaded successfully!$flavor_msg"
}

# --- Function: Build Android App Bundle ---
build_appbundle() {
 echo ":package: Building Android App Bundle..."
 if $FLUTTER_CMD build appbundle $FLAVOR_FLAGS; then
  echo ":white_check_mark: App Bundle build completed!"
  local flavor_msg=""
  if [ -n "$FLAVOR_NAME" ]; then
   flavor_msg=" (Flavor: $FLAVOR_NAME)"
  fi
  send_notification "Flutter Build" "Android App Bundle build completed successfully!$flavor_msg"
 else
  send_notification "Flutter Build" "Android App Bundle build failed!" "false"
  return 1
 fi
}

# --- Function: Build iOS IPA ---
build_ios() {
 echo ":package: Building iOS IPA..."
 if $FLUTTER_CMD build ipa $FLAVOR_FLAGS; then
  echo ":white_check_mark: IPA build completed!"
  local flavor_msg=""
  if [ -n "$FLAVOR_NAME" ]; then
   flavor_msg=" (Flavor: $FLAVOR_NAME)"
  fi
  send_notification "Flutter Build" "iOS IPA build completed successfully!$flavor_msg"
 else
  send_notification "Flutter Build" "iOS IPA build failed!" "false"
  return 1
 fi
}

# --- Function: Upload iOS IPA to Google Drive ---
upload_ios_ipa_to_drive() {
 echo ":lightning:  Preparing to upload iOS IPA to Google Drive..."
 
 # Setup gdrive
 ensure_gdrive_installed || return 1
 ensure_gdrive_authenticated || return 1
 
 # Get app version
 local app_version=$(get_app_version)
  if [ -n "$app_version" ]; then
   echo ":label: App version: $app_version"
 fi
 
 # Find IPA file (iOS uses a different structure)
 local ipa_path=$(find build/ios/ipa -name "*.ipa" -type f | head -n 1)
 if [ -z "$ipa_path" ]; then
  echo ":x: IPA not found in build/ios/ipa/"
  return 1
 fi
 
 # Build filename
 local filename=$(build_upload_filename "ipa" "$FLAVOR_NAME" "$app_version" "$CUSTOM_NAME")
 
 echo "Uploading: $(basename "$filename")"
 
 # Upload file
 local file_url=$(upload_single_file_to_drive "$ipa_path" "$filename" "$GDRIVE_FOLDER_ID" "$FLAVOR_NAME")
 
 if [ $? -ne 0 ] || [ -z "$file_url" ]; then
  send_notification "Google Drive Upload" "iOS IPA upload failed!" "false"
  return 1
 fi
 
 # Display success message
 display_upload_success "iOS IPA" "$FLAVOR_NAME" "$CUSTOM_NAME" "$file_url"
 
 # Copy link to clipboard
 copy_to_clipboard "$file_url"

 # Delete local IPA file after successful upload
 echo ":wastebasket:  Deleting local IPA file..."
 if rm -f "$ipa_path"; then
  echo ":white_check_mark: Local IPA file deleted successfully!"
 else
  echo ":warning:  Failed to delete local IPA file."
 fi
 
 # Send notification
 local flavor_msg=""
 [ -n "$FLAVOR_NAME" ] && flavor_msg=" (Flavor: $FLAVOR_NAME)"
 send_notification "Google Drive Upload" "iOS IPA uploaded successfully!$flavor_msg"
}

# --- Function: Upload multiple iOS IPAs to Google Drive ---
upload_multiple_ios_ipas_to_drive() {
 echo ":lightning: Preparing to upload multiple iOS IPAs to Google Drive..."
 
 # Setup gdrive
 ensure_gdrive_installed || return 1
 ensure_gdrive_authenticated || return 1
 
 # Get app version
 local app_version=$(get_app_version)
  if [ -n "$app_version" ]; then
   echo ":label: App version: $app_version"
 fi
 
 local upload_count=0
 UPLOAD_LINKS=()
 
 for ipa_info in "${BUILT_IPAS[@]}"; do
  local ipa_path="${ipa_info%%:*}"
  local flavor_name="${ipa_info##*:}"
  
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ":arrow_up_small: Uploading flavor: $flavor_name"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  
  # Build filename
  local filename=$(build_upload_filename "ipa" "$flavor_name" "$app_version" "$CUSTOM_NAME")
  
  echo "Uploading: $(basename "$filename")"
  
  # Upload file
  local file_url=$(upload_single_file_to_drive "$ipa_path" "$filename" "$GDRIVE_FOLDER_ID" "$flavor_name")
  
  if [ $? -eq 0 ] && [ -n "$file_url" ]; then
   # Display success message
   display_upload_success "iOS IPA" "$flavor_name" "$CUSTOM_NAME" "$file_url"
   UPLOAD_LINKS+=("$flavor_name: $file_url")
   ((upload_count++))
  fi
 done
 
 echo ""
 echo "═══════════════════════════════════════"
 echo ":tada: Upload completed!"
 echo "Uploaded: $upload_count/${#BUILT_IPAS[@]}"
 echo "═══════════════════════════════════════"
 echo ""
 echo ":link: Download Links:"
 for link in "${UPLOAD_LINKS[@]}"; do
  echo "  • $link"
 done
 echo ""
 
 # Copy all links to clipboard
 local all_links=$(printf "%s\n" "${UPLOAD_LINKS[@]}")
 copy_to_clipboard "$all_links"
 
 # Send notification
 if [ "$upload_count" -eq "${#BUILT_IPAS[@]}" ]; then
  send_notification "Google Drive Upload" "All $upload_count iOS IPAs uploaded successfully!"
 elif [ "$upload_count" -gt 0 ]; then
  send_notification "Google Drive Upload" "Uploaded $upload_count/${#BUILT_IPAS[@]} iOS IPAs" "false"
 else
  send_notification "Google Drive Upload" "Upload failed!" "false"
 fi
}

# --- Validate we're in a Flutter project ---
validate_flutter_project

# --- First Menu: Select FVM ---
select_fvm

# --- Second Menu: Choose What to Do ---
show_menu() {
 echo ""
 echo "═══════════════════════════════════════"
 echo "     FLUTTER BUILD AUTOMATION MENU"
 echo "═══════════════════════════════════════"
 echo "1.  Clean and get dependencies Flutter"
 echo "2.  Clean Android project only"
 echo "3.  Clean iOS project only"
 echo "4.  Build Android APK"
 echo "5.  Build Android APK and Upload to Google Drive"
 echo "6.  Build Android App Bundle"
 echo "7.  Build iOS IPA"
 echo "8.  Build multiple Android APKs (multi-flavor)"
 echo "9.  Build multiple Android APKs and Upload (multi-flavor)"
 echo "10. Build multiple Android App Bundles (multi-flavor)"
 echo "11. Build multiple Android App Bundles and Upload (multi-flavor)"
 echo "12. Build multiple iOS IPAs (multi-flavor)"
 echo "13. Clean ALL (Flutter, Android, iOS)"
 echo "14. Build ALL (Android + iOS)"
 echo "15. Build iOS IPA and Upload to Google Drive"
 echo "16. Build multiple iOS IPAs and Upload (multi-flavor)"
 echo "17. Build APK + IPA and Upload to Google Drive"
 echo "18. Build ALL (Android + iOS) - Multiple Flavors"
 echo "19. Quit"
 echo "═══════════════════════════════════════"
 read -p "Enter your choice [1-19]: " choice
}

# --- Main Logic ---
while true; do
 show_menu
 case $choice in
 1)
  clean_flutter
  ;;
 2)
  clean_android
  ;;
 3)
  clean_ios
  ;;
 4)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  build_android
  ;;
 5)
  choose_project || break
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  build_android
  upload_apk_to_drive
  clean_flutter
  ;;
 6)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  build_appbundle
  ;;
 7)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  clean_ios
  build_ios
  ;;
 8)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  build_multiple_android_apks
  ;;
 9)
  choose_project || continue
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  build_multiple_android_apks
  upload_multiple_apks_to_drive
  clean_flutter
  ;;
 10)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  build_multiple_appbundles
  ;;
 11)
  choose_project || continue
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  build_multiple_appbundles
  upload_multiple_appbundles_to_drive
  clean_flutter
  ;;
 12)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  clean_ios
  build_multiple_ios_ipas
  ;;
 13)
  clean_flutter
  clean_android
  clean_ios
  ;;
 13)
  clean_flutter
  clean_android
  clean_ios
  ;;
 14)
  prompt_flavor
  echo ""
  echo "═══════════════════════════════════════"
  echo "      SELECT BUILD COMBINATION"
  echo "═══════════════════════════════════════"
  echo "1. APK + IPA"
  echo "2. App Bundle + IPA"
  echo "3. APK + App Bundle + IPA (All)"
  echo "═══════════════════════════════════════"
  read -p "Enter your choice [1-3]: " build_choice
  clean_flutter
  clean_android
  clean_ios
  case $build_choice in
  1)
   # APK + IPA only
  build_android
   build_ios
   ;;
  2)
   # App Bundle + IPA only
  build_appbundle
  build_ios
  ;;
  3)
   # APK + App Bundle + IPA (All)
   build_android
   build_appbundle
   build_ios
   ;;
  *)
   echo ":x: Invalid choice! Please choose 1, 2, or 3."
   continue
   ;;
  esac
  ;;
 15)
  choose_project || continue
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_flavor
  clean_flutter
  clean_ios
  build_ios
  upload_ios_ipa_to_drive
  clean_flutter
  ;;
 16)
  choose_project || continue
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  clean_flutter
  clean_ios
  build_multiple_ios_ipas
  upload_multiple_ios_ipas_to_drive
  clean_flutter
  ;;
 17)
  echo ""
  echo "═══════════════════════════════════════"
  echo "    SELECT GOOGLE DRIVE FOLDERS"
  echo "═══════════════════════════════════════"
  echo ":android: Select folder for Android APK:"
  choose_project || continue
  GDRIVE_FOLDER_ID_APK="$GDRIVE_FOLDER_ID"
  APP_NAME_APK="$APP_NAME"
  echo ""
  echo ":apple: Select folder for iOS IPA:"
  choose_project_ipa || continue
  # Save IPA folder variables (set inside choose_project_ipa)
  GDRIVE_FOLDER_ID_IPA_SAVED="$GDRIVE_FOLDER_ID_IPA"
  APP_NAME_IPA_SAVED="$APP_NAME_IPA"
  echo ""
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  echo ""
  echo "═══════════════════════════════════════"
  echo "      SELECT BUILD MODE"
  echo "═══════════════════════════════════════"
  echo "1. Single flavor (or no flavor)"
  echo "2. Multiple flavors"
  echo "═══════════════════════════════════════"
  read -p "Enter your choice [1-2]: " mode_choice
  case $mode_choice in
  1)
   # Single flavor workflow
   prompt_flavor
   clean_flutter
   clean_android
   clean_ios
   build_android
   build_ios
   # Upload APK to Android folder
   APP_NAME="$APP_NAME_APK"
   GDRIVE_FOLDER_ID="$GDRIVE_FOLDER_ID_APK"
   upload_apk_to_drive
   # Upload IPA to iOS folder
   APP_NAME="$APP_NAME_IPA_SAVED"
   GDRIVE_FOLDER_ID="$GDRIVE_FOLDER_ID_IPA_SAVED"
   upload_ios_ipa_to_drive
   clean_flutter
   ;;
  2)
   # Multiple flavors workflow
   prompt_multiple_flavors || continue
   clean_flutter
   clean_android
   clean_ios
   build_multiple_android_apks
   build_multiple_ios_ipas
   # Upload APKs to Android folder
   APP_NAME="$APP_NAME_APK"
   GDRIVE_FOLDER_ID="$GDRIVE_FOLDER_ID_APK"
   upload_multiple_apks_to_drive
   # Upload IPAs to iOS folder
   APP_NAME="$APP_NAME_IPA_SAVED"
   GDRIVE_FOLDER_ID="$GDRIVE_FOLDER_ID_IPA_SAVED"
   upload_multiple_ios_ipas_to_drive
   clean_flutter
   ;;
  *)
   echo ":x: Invalid mode choice! Please choose 1 or 2."
   continue
   ;;
  esac
  ;;
 18)
  read -p "Enter custom name (optional, press Enter to skip): " CUSTOM_NAME
  if [ -z "$CUSTOM_NAME" ]; then
   CUSTOM_NAME=""
  else
   echo ":label: Custom name: $CUSTOM_NAME"
  fi
  prompt_multiple_flavors || continue
  echo ""
  echo "═══════════════════════════════════════"
  echo "      SELECT BUILD COMBINATION"
  echo "═══════════════════════════════════════"
  echo "1. APK + IPA"
  echo "2. App Bundle + IPA"
  echo "3. APK + App Bundle + IPA (All)"
  echo "═══════════════════════════════════════"
  read -p "Enter your choice [1-3]: " build_choice
  clean_flutter
  clean_android
  clean_ios
  case $build_choice in
  1)
   # APK + IPA only
   build_multiple_android_apks
   build_multiple_ios_ipas
   ;;
  2)
   # App Bundle + IPA only
   build_multiple_appbundles
   build_multiple_ios_ipas
   ;;
  3)
   # APK + App Bundle + IPA (All)
   build_multiple_android_apks
   build_multiple_appbundles
   build_multiple_ios_ipas
   ;;
  *)
   echo ":x: Invalid choice! Please choose 1, 2, or 3."
   continue
   ;;
  esac
  ;;
 19)
  echo ":wave: Exiting..."
  break
  ;;
 *)
  echo ":x: Invalid option! Please choose a valid option."
  ;;
 esac
done
